# 覆盖旧记录选项和问题反馈样式优化说明

## 修改日期

2025 年 10 月 23 日

## 修改内容

### 1. 新增"覆盖已存在的记录"选项

#### 功能说明

在批量上传界面的"开始上传"按钮左侧添加了一个复选框，用户可以选择是否覆盖已存在的日报记录。

#### 修改详情

**位置**：

- 在"清空列表"和"开始上传"按钮之间
- 默认不勾选（跳过已存在的记录）

**界面效果**：

```
[清空列表]  [✓覆盖已存在的记录]  [开始上传]
```

#### 代码实现

##### 1.1 UI 组件添加

**文件**：`ui/upload_widget.py`

```python
# 导入QCheckBox
from PyQt6.QtWidgets import (
    ..., QCheckBox
)

# 在按钮布局中添加复选框
button_layout = QHBoxLayout()
button_layout.addStretch()

self.clear_button = QPushButton("清空列表")
...
button_layout.addWidget(self.clear_button)

# ✅ 新增：覆盖旧记录选项
self.overwrite_checkbox = QCheckBox("覆盖已存在的记录")
self.overwrite_checkbox.setStyleSheet("""
    QCheckBox {
        color: #666666;
        font-size: 14px;
        padding: 5px;
    }
    QCheckBox::indicator {
        width: 18px;
        height: 18px;
    }
""")
self.overwrite_checkbox.setChecked(False)  # 默认不勾选
button_layout.addWidget(self.overwrite_checkbox)

self.upload_button = QPushButton("开始上传")
...
```

##### 1.2 上传线程修改

**文件**：`ui/upload_widget.py`

```python
class UploadThread(QThread):
    """上传线程"""

    def __init__(self, parsed_reports: list, project_id: int, reporter_id: int,
                 api_base_url: str, token: str, overwrite_existing: bool = False):
        super().__init__()
        self.parsed_reports = parsed_reports
        self.project_id = project_id
        self.reporter_id = reporter_id
        self.api_base_url = api_base_url
        self.token = token
        self.overwrite_existing = overwrite_existing  # ✅ 新增参数

    def run(self):
        """执行上传"""
        try:
            # 转换为API格式
            api_data = convert_to_api_format(
                self.parsed_reports,
                self.project_id,
                self.reporter_id,
                self.overwrite_existing  # ✅ 传递参数
            )
            ...
```

##### 1.3 开始上传方法修改

**文件**：`ui/upload_widget.py`

```python
def start_upload(self):
    """开始上传"""
    ...

    # ✅ 获取是否覆盖旧记录的选项
    overwrite_existing = self.overwrite_checkbox.isChecked()

    # 创建并启动上传线程，使用已解析的数据
    self.upload_thread = UploadThread(
        self.parsed_reports,
        project_id,
        reporter_id,
        api_base_url,
        token,
        overwrite_existing  # ✅ 传递参数
    )
    ...
```

##### 1.4 数据转换函数修改

**文件**：`convert_to_api_format.py`

```python
def convert_to_api_format(parsed_data, project_id, reporter_id, overwrite_existing=False):
    """
    将解析后的JSON转换为API批量导入格式

    :param parsed_data: 解析后的日报数据列表
    :param project_id: 项目ID
    :param reporter_id: 填报人ID
    :param overwrite_existing: 是否覆盖已存在的记录，默认False  # ✅ 新增参数
    :return: API格式的数据
    """
    ...

    # 构建API格式
    api_data = {
        "projectId": project_id,
        "reporterId": reporter_id,
        "overwriteExisting": overwrite_existing,  # ✅ 新增字段
        "reports": reports
    }

    return api_data
```

##### 1.5 上传服务修改

**文件**：`services/upload_service.py`

```python
def upload_daily_report_excel(
    self,
    excel_path: str,
    project_id: int,
    reporter_id: int,
    overwrite_existing: bool = False,  # ✅ 新增参数
    progress_callback: Optional[Callable[[int], None]] = None
) -> Dict:
    """
    上传日报Excel文件

    :param excel_path: Excel文件路径
    :param project_id: 项目ID
    :param reporter_id: 填报人ID
    :param overwrite_existing: 是否覆盖已存在的记录，默认False  # ✅ 新增
    :param progress_callback: 进度回调函数
    :return: 上传结果字典
    :raises Exception: 上传失败时抛出异常
    """
    ...

    # 2. 转换为API格式 (30-40%)
    api_data = convert_to_api_format(
        all_reports,
        project_id,
        reporter_id,
        overwrite_existing  # ✅ 传递参数
    )
    ...
```

#### API 数据格式

**修改前**：

```json
{
  "projectId": 9,
  "reporterId": 10,
  "reports": [...]
}
```

**修改后**：

```json
{
  "projectId": 9,
  "reporterId": 10,
  "overwriteExisting": false,  // ✅ 新增字段
  "reports": [...]
}
```

#### 功能说明

| overwriteExisting | 说明               | 行为                                              |
| ----------------- | ------------------ | ------------------------------------------------- |
| `false`（默认）   | 不覆盖已存在的记录 | 如果该日期已有日报，跳过该记录，计入 skippedCount |
| `true`            | 覆盖已存在的记录   | 如果该日期已有日报，用新数据覆盖旧数据            |

### 2. 问题反馈样式优化

#### 优化说明

移除问题反馈标签页中的子滚动区域，确保所有数据完整展示，使用对话框的整体滚动。

#### 实现要点

##### 2.1 移除子滚动区域

**文件**：`ui/daily_report_detail_dialog.py`

**修改位置**：`create_problems_and_requirements_tab` 方法

**修改前**：

```python
def create_problems_and_requirements_tab(self):
    """创建问题反馈选项卡（包含问题反馈和需求描述）"""
    widget = QWidget()

    # ❌ 创建了子滚动区域 - 导致嵌套滚动
    scroll = QScrollArea()
    scroll.setWidgetResizable(True)
    scroll.setStyleSheet("QScrollArea { border: none; }")

    container = QWidget()
    main_layout = QVBoxLayout(container)
    ...
    scroll.setWidget(container)

    outer_layout = QVBoxLayout(widget)
    outer_layout.addWidget(scroll)

    return widget
```

**修改后**：

```python
def create_problems_and_requirements_tab(self):
    """创建问题反馈选项卡（包含问题反馈和需求描述）"""
    widget = QWidget()
    layout = QVBoxLayout(widget)
    layout.setSpacing(20)
    layout.setContentsMargins(10, 10, 10, 10)

    # ✅ 直接添加分组，不使用子滚动区域
    problems_group = self._create_problems_group()
    layout.addWidget(problems_group)

    requirements_group = self._create_requirements_group()
    layout.addWidget(requirements_group)

    layout.addStretch()

    return widget
```

##### 2.2 表格样式优化

**文件**：`ui/daily_report_detail_dialog.py`

**修改位置**：`_setup_table_style` 方法

```python
def _setup_table_style(self, table: QTableWidget):
    """设置表格样式"""
    ...

    # ✅ 禁用表格自己的滚动条，使用外部滚动
    table.setVerticalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)
    table.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)

    # ✅ 调整表格高度以适应内容
    table.setSizePolicy(QSizePolicy.Policy.Expanding,
                       QSizePolicy.Policy.Minimum)

    # ✅ 计算并设置表格的最小高度（根据行数）
    row_count = table.rowCount()
    header_height = table.horizontalHeader().height()
    row_height = table.verticalHeader().defaultSectionSize()
    total_height = header_height + (row_count * row_height) + 2
    table.setMinimumHeight(total_height)
    table.setMaximumHeight(total_height)
```

#### 滚动层次对比

**修改前（有嵌套滚动问题）**：

```
QDialog (对话框整体滚动) ✅
└── QTabWidget
    └── 问题反馈 Tab
        └── QScrollArea (子区域滚动) ❌ 导致嵌套滚动
            └── Container
                ├── QGroupBox "1. 问题反馈"
                │   └── QTableWidget (有自己的滚动条) ❌
                └── QGroupBox "2. 需求描述"
                    └── QTableWidget (有自己的滚动条) ❌
```

**修改后（统一滚动）**：

```
QDialog (对话框整体滚动) ✅ 只有这一个滚动条
└── QTabWidget
    └── 问题反馈 Tab
        ├── QGroupBox "1. 问题反馈"
        │   └── QTableWidget (无滚动条，高度自适应) ✅
        └── QGroupBox "2. 需求描述"
            └── QTableWidget (无滚动条，高度自适应) ✅
```

#### 优化效果

1. **无子区域滚动**

   - ✅ 移除了问题反馈标签页的 QScrollArea
   - ✅ 所有内容在对话框整体滚动中展示
   - ✅ 避免了嵌套滚动的混乱体验
   - ✅ 滚动流畅，体验统一

2. **表格完整展示**

   - ✅ 表格禁用自己的滚动条
   - ✅ 表格高度精确匹配内容
   - ✅ 所有数据完整显示，无需子滚动
   - ✅ 数据不会被截断

3. **视觉体验统一**
   - ✅ 所有标签页滚动行为一致
   - ✅ 只有一个滚动条（对话框级别）
   - ✅ 无多余空白
   - ✅ 视觉效果整洁

## 修改文件列表

### 修改的文件

| 文件                               | 修改内容                                                                                           |
| ---------------------------------- | -------------------------------------------------------------------------------------------------- |
| `ui/upload_widget.py`              | 1. 导入 QCheckBox<br>2. 添加覆盖选项复选框<br>3. 修改 UploadThread 类<br>4. 修改 start_upload 方法 |
| `convert_to_api_format.py`         | 1. 添加 overwrite_existing 参数<br>2. 在 API 数据中添加 overwriteExisting 字段                     |
| `services/upload_service.py`       | 1. 添加 overwrite_existing 参数<br>2. 传递参数到 convert_to_api_format                             |
| `ui/daily_report_detail_dialog.py` | 1. 移除问题反馈标签页的 QScrollArea<br>2. 禁用表格滚动条<br>3. 表格高度自适应                      |

## 测试建议

### 1. 覆盖选项测试

#### 测试场景 1：不勾选（默认）

1. 上传包含已存在日期的日报
2. 预期：已存在的记录被跳过，计入 skippedCount
3. 验证：检查上传结果中的 skippedCount

#### 测试场景 2：勾选覆盖

1. 勾选"覆盖已存在的记录"
2. 上传包含已存在日期的日报
3. 预期：已存在的记录被新数据覆盖
4. 验证：检查数据库中的记录是否更新

#### 测试场景 3：切换选项

1. 多次切换复选框状态
2. 验证每次上传的行为符合预期

### 2. 问题反馈样式测试

#### 测试场景 1：少量数据

1. 打开只有 1-2 条问题的日报详情
2. 验证表格高度适当，无滚动条
3. 确认可以看到所有数据

#### 测试场景 2：大量数据

1. 打开有 10+条问题的日报详情
2. 验证所有数据完整显示
3. 确认只有外部滚动条，表格无滚动条
4. 测试滚动是否流畅

#### 测试场景 3：空数据

1. 打开没有问题反馈的日报
2. 验证显示"暂无问题反馈"提示
3. 确认布局正常

## 用户使用指南

### 覆盖旧记录功能

**默认行为（不勾选）**：

- 上传时会跳过已存在的日报记录
- 适用于增量上传，避免重复数据
- 上传结果会显示跳过的记录数量

**勾选后的行为**：

- 上传时会覆盖已存在的日报记录
- 适用于修正错误数据或更新记录
- 谨慎使用，会永久覆盖旧数据

**使用建议**：

1. 首次上传：不勾选（默认）
2. 修正错误：勾选覆盖
3. 更新数据：勾选覆盖
4. 批量导入：根据需求选择

### 查看日报详情

**问题反馈区域**：

- 所有问题和需求完整展示
- 使用整体滚动条查看所有内容
- 表格不会出现单独的滚动条
- 数据不会被截断

## 注意事项

### 1. 覆盖选项

- ⚠️ 覆盖操作不可撤销
- ⚠️ 建议在覆盖前确认数据正确性
- ⚠️ 重要数据建议先备份

### 2. 数据完整性

- ✅ API 会返回详细的上传结果
- ✅ 包括成功、失败、跳过的记录数
- ✅ 可以查看详细的错误信息

### 3. 性能考虑

- 表格高度根据行数动态计算
- 数据量大时可能影响渲染性能
- 建议单次上传不超过 100 条记录

## 后续优化建议

### 1. 确认对话框增强

在勾选覆盖选项时，显示更明显的警告提示

### 2. 操作日志

记录覆盖操作的日志，方便追溯

### 3. 批量操作

支持选择性覆盖（指定日期范围）

### 4. 数据对比

覆盖前显示新旧数据对比
