# 序号规则和字段优化说明

## 概述

根据 Excel 数据结构的实际规则，优化了序号解析逻辑和上传字段，确保只有真实内容被上传。

## 核心规则

### 序号分类

| 序号格式         | 说明                     | 处理方式                |
| ---------------- | ------------------------ | ----------------------- |
| `3.1`, `3.2`     | 带小数点的序号，真实内容 | ✅ 上传                 |
| `3`              | 纯数字序号，分区标题     | ❌ 不上传（仅作为标记） |
| `二`, `三`, `四` | 中文序号，大区标题       | ❌ 不上传（仅作为标记） |

### 适用范围

1. **逐项进度汇报（序号 2.x）**

   - 只上传序号以 `2.` 开头的任务
   - 保留字段：`taskNo`, `taskName`, `plannedProgress`, `actualProgress`, `deviationReason`, `impactMeasures`

2. **明日工作计划（序号 3.x）** ✨ 已优化

   - 只上传序号以 `3.` 开头的计划
   - **移除字段**：`planNo`（不需要上传）
   - **保留字段**：`taskName`, `goal`, `responsiblePerson`, `requiredResources`, `remarks`

3. **问题反馈（纯数字序号）**

   - 只上传序号为纯数字的问题记录（如 `2`, `3`, `4`）
   - 不上传纯数字标题行（如 `1` 表示"问题描述"）

4. **需求描述（纯数字序号）**
   - 只上传序号为纯数字的需求记录
   - 不上传纯数字标题行（如 `2` 表示"需求描述"）

## 修改内容

### 1. parse_daily_report_excel.py

#### 变更：移除 planNo 字段（保留 taskName）

**修改前**：

```python
def _parse_tomorrow_plans(self, ws, start_row: int, end_row: int) -> List[Dict]:
    """解析明天工作计划（序号3.x）"""
    plans = []
    for i in range(start_row, end_row + 1):
        plan_no = self._get_cell_value(ws, i, 1)
        # ...
        if task_name and plan_no.startswith("3."):
            plans.append({
                "planNo": plan_no,      # ❌ 移除
                "taskName": task_name,  # ✅ 保留
                "goal": goal,
                # ...
            })
```

**修改后**：

```python
def _parse_tomorrow_plans(self, ws, start_row: int, end_row: int) -> List[Dict]:
    """解析明天工作计划（序号3.x）"""
    plans = []
    for i in range(start_row, end_row + 1):
        plan_no = self._get_cell_value(ws, i, 1)
        # ...
        if task_name and plan_no.startswith("3."):
            plans.append({
                "taskName": task_name,              # ✅ 保留
                "goal": goal,                       # ✅ 保留
                "responsiblePerson": responsible_person,
                "requiredResources": required_resources,
                "remarks": remarks
            })
```

### 2. convert_to_api_format.py

无需修改，因为：

- Parser 已经移除了 `planNo` 字段
- 转换函数自动生成 JSON 字符串，不包含已移除的字段

## 上传格式对比

### 修改前（包含 planNo 和 taskName）

```json
{
  "tomorrowPlans": "[{\"planNo\":\"3.1\",\"taskName\":\"电伴热接线\",\"goal\":\"完成\"}]"
}
```

### 修改后（只移除 planNo，保留 taskName）

```json
{
  "tomorrowPlans": "[{\"taskName\":\"电伴热接线\",\"goal\":\"完成\",\"responsiblePerson\":\"张三\",\"requiredResources\":\"工具\",\"remarks\":\"按时完成\"}]"
}
```

## 数据验证示例

### 原始 Excel 数据

```
序号 | 任务/计划     | 目标 | 负责人 | 所需资源 | 备注
3    | [标题]       |      |       |         |
3.1  | 电伴热接线   | 完成 | 张三  | 工具    | 按时完成
3.2  | 接线测试     | 完成 | 李四  | 测试设备 | 无
```

### 解析结果

```python
[
    {
        "taskName": "电伴热接线",
        "goal": "完成",
        "responsiblePerson": "张三",
        "requiredResources": "工具",
        "remarks": "按时完成"
    },
    {
        "taskName": "接线测试",
        "goal": "完成",
        "responsiblePerson": "李四",
        "requiredResources": "测试设备",
        "remarks": "无"
    }
]
```

## 测试步骤

1. **验证 Parser 输出**

   ```bash
   python3 parse_daily_report_excel.py <excel文件> output.json
   cat output.json | grep -A 10 "tomorrowPlans"
   ```

2. **验证转换后的格式**

   ```bash
   python3 convert_to_api_format.py output.json <项目ID> <填报人ID> api.json
   cat api.json | grep -A 10 "tomorrowPlans"
   ```

3. **确认字段正确**
   - ✅ 包含 `taskName` 字段
   - ✅ 包含 `goal` 字段
   - ✅ 不包含 `planNo` 字段

## 相关问题修复

✅ 序号 3 的纯数字分区标题不再上传  
✅ 只有 3.1、3.2 等完整序号的内容才上传  
✅ planNo 字段已移除  
✅ taskName 字段已保留  
✅ 符合 API 批量导入的实际需求

## 后续扩展

未来如果需要：

- 其他字段的移除：遵循同样的规则在 Parser 中处理
- 字段重映射：在 Parser 中重命名字段，无需修改 Convert 函数
- 条件过滤：在 Parser 中实现，保持 Convert 函数的通用性

---

**修改日期**：2025-10-23  
**涉及文件**：`parse_daily_report_excel.py`
