# 文件管理和全选功能说明

## 修改日期

2025 年 10 月 23 日

## 功能概述

为文件管理和批量选择功能进行了优化：

- ✅ **单文件模式**：一次只能添加一个文件，新文件替换旧文件
- ✅ **自动预览**：添加文件后自动执行预览，无需手动点击
- ✅ **全选功能**：一键全选/反选所有日报
- ✅ **加载动画**：预览时显示加载动画，提升用户体验

## 核心功能

### 1. 单文件管理模式

**工作流程**：

```
点击"添加文件"
    ↓
选择 Excel 文件
    ↓
✅ 自动清空旧文件
    ↓
✅ 新文件替换旧文件
    ↓
✅ 自动执行预览
    ↓
表格显示日报数据
```

**特点**：

- 防止多文件混淆
- 用户体验简化
- 自动化流程

### 2. 全选/反选按钮

**按钮位置**：

```
[全选] [反选] [预览数据]
  ✅      ✅
```

**功能**：

- 全选：一键勾选所有日报
- 反选：一键清除所有勾选
- 实时更新上传按钮文本

### 3. 加载动画

**显示时机**：

```
点击"添加文件" → 自动预览
                  ↓
        ⏳ 正在加载数据...
                  ↓
        解析完成，显示表格
                  ↓
        ⏳ 隐藏加载动画
```

**样式**：

- 大蓝色提示文本
- 中央对齐
- 预览完成后自动隐藏

### 4. 自动预览

**触发时机**：

```
用户添加文件
    ↓
自动调用 preview_data()
    ↓
显示加载动画
    ↓
解析 Excel
    ↓
填充表格
    ↓
隐藏加载动画，显示数据
```

## 实现细节

### 文件修改

**文件**：`ui/upload_widget.py`

#### 1. 单文件添加模式

**修改前**：

```python
def add_files(self):
    """添加文件"""
    files, _ = QFileDialog.getOpenFileNames(...)
    if files:
        for file_path in files:  # ❌ 支持多文件
            if file_path not in self.selected_files:
                self.selected_files.append(file_path)
                # ...
```

**修改后**：

```python
def add_files(self):
    """添加文件（一次只能添加一个，新文件替换旧文件）"""
    files, _ = QFileDialog.getOpenFileNames(...)
    if files:
        # ✅ 只保留第一个选中的文件
        file_path = files[0]

        # ✅ 清空旧文件
        self.selected_files.clear()
        self.file_list.clear()
        self.parsed_reports.clear()
        self.checked_reports.clear()
        self.data_table.setRowCount(0)

        # ✅ 添加新文件
        self.selected_files.append(file_path)
        # ...

        # ✅ 自动预览
        self.preview_button.setEnabled(True)
        QApplication.processEvents()
        self.preview_data()  # 直接调用预览
```

#### 2. 全选/反选按钮

**添加按钮**：

```python
def create_preview_panel(self):
    # ...
    # ✅ 全选按钮
    self.select_all_button = QPushButton("✓ 全选")
    self.select_all_button.setMinimumSize(100, 40)
    self.select_all_button.clicked.connect(self.select_all_reports)
    self.select_all_button.setEnabled(False)
    button_layout.addWidget(self.select_all_button)

    # ✅ 反选按钮
    self.deselect_all_button = QPushButton("✗ 反选")
    self.deselect_all_button.setMinimumSize(100, 40)
    self.deselect_all_button.clicked.connect(self.deselect_all_reports)
    self.deselect_all_button.setEnabled(False)
    button_layout.addWidget(self.deselect_all_button)
```

**实现方法**：

```python
def select_all_reports(self):
    """全选所有日报"""
    for row in range(self.data_table.rowCount()):
        item = self.data_table.item(row, 0)
        if item:
            item.setCheckState(Qt.CheckState.Checked)

def deselect_all_reports(self):
    """反选所有日报"""
    for row in range(self.data_table.rowCount()):
        item = self.data_table.item(row, 0)
        if item:
            item.setCheckState(Qt.CheckState.Unchecked)
```

#### 3. 加载动画

**添加加载标签**：

```python
def create_preview_panel(self):
    # ...
    # ✅ 加载动画标签
    self.loading_label = QLabel("⏳ 正在加载数据...")
    self.loading_label.setStyleSheet("""
        color: #2196F3;
        font-size: 14px;
        font-weight: bold;
        padding: 10px;
    """)
    self.loading_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
    self.loading_label.setVisible(False)
    layout.addWidget(self.loading_label)
```

**显示/隐藏**：

```python
def preview_data(self):
    # ✅ 显示加载动画
    self.loading_label.setVisible(True)

    try:
        # ... 解析数据 ...

        # ✅ 隐藏加载动画
        self.loading_label.setVisible(False)
    finally:
        # ✅ 确保隐藏加载动画
        self.loading_label.setVisible(False)
```

## 用户操作流程

### 场景 1：单文件上传

```
1. 点击"添加文件"
   ↓
2. 选择 Excel 文件
   ↓
3. ⏳ 显示加载动画
   ↓
4. 自动预览数据
   ↓
5. 表格显示日报
   ↓
6. 点击"全选"勾选所有日报
   ↓
7. 点击"开始上传 (5/5)"
   ↓
8. 上传完成
```

### 场景 2：更换文件

```
1. 已添加文件 A
2. 表格显示文件 A 的数据
   ↓
3. 点击"添加文件"选择文件 B
   ↓
4. 自动清空文件 A 的数据
   ↓
5. 显示文件 B 的数据
   ↓
6. 原有勾选被清除
```

### 场景 3：批量勾选

```
1. 预览数据显示 10 条日报
   ↓
2. 点击"全选"
   ↓
3. 所有勾选框立即勾选
   ↓
4. 按钮显示"开始上传 (10/10)"
   ↓
5. 点击"反选"
   ↓
6. 所有勾选框立即清除
   ↓
7. 按钮显示"开始上传"，禁用
```

## 特性亮点

### ✅ 简化操作

- 单文件模式，避免多文件混淆
- 自动预览，无需手动触发
- 一键全选，快速操作

### ✅ 用户体验

- 加载动画提示正在处理
- 按钮状态实时反馈
- 流程简化，操作流畅

### ✅ 可靠性

- 新文件自动清空旧数据
- 状态同步更新
- 错误处理完善

## 按钮状态

### 预览前

```
全选 [禁用]  反选 [禁用]  预览数据 [启用/禁用]
```

### 预览时

```
全选 [禁用]  反选 [禁用]  预览数据 [禁用]
⏳ 正在加载数据...
```

### 预览后

```
全选 [启用]  反选 [启用]  预览数据 [启用]
[表格显示数据]
```

## 加载动画样式

**预览时**：

```
⏳ 正在加载数据...  ← 蓝色，14号字，加粗，居中
```

**完成后**：

```
[表格显示数据]  ← 加载标签隐藏
```

## 处理流程图

```
用户添加文件
    ↓
清空旧数据
    ↓
显示加载动画
    ↓
禁用按钮
    ↓
解析 Excel
    ↓
填充表格
    ↓
启用全选/反选按钮
    ↓
隐藏加载动画
    ↓
显示完成提示
```

## 测试建议

### 测试场景 1：单文件添加

1. 点击"添加文件"选择 A.xlsx
2. 自动预览 A.xlsx 数据
3. 验证表格显示正确
4. 再次点击"添加文件"选择 B.xlsx
5. 验证 A.xlsx 数据被清除
6. 验证表格显示 B.xlsx 数据

### 测试场景 2：全选功能

1. 预览数据显示 5 条日报
2. 点击"全选"
3. 验证所有 5 条都被勾选
4. 按钮显示"开始上传 (5/5)"
5. 点击"反选"
6. 验证所有勾选被清除
7. 按钮显示"开始上传"，禁用

### 测试场景 3：加载动画

1. 点击"添加文件"
2. 验证加载动画显示
3. 验证加载动画在预览完成后隐藏
4. 验证表格数据正常显示

### 测试场景 4：按钮启用/禁用

1. 初始状态：全选/反选按钮禁用
2. 点击"添加文件"
3. 预览中：全选/反选按钮禁用
4. 预览完成：全选/反选按钮启用
5. 点击"清空列表"
6. 验证按钮重新禁用

## 修改总结

### 改动文件

- ✅ `ui/upload_widget.py`

### 改动功能

1. ✅ 单文件模式：一次只能添加一个文件
2. ✅ 自动预览：添加文件后自动执行预览
3. ✅ 全选按钮：一键全选所有日报
4. ✅ 反选按钮：一键清除所有勾选
5. ✅ 加载动画：预览时显示加载提示

## 相关文档

- 批量上传勾选功能说明.md
- 文件上传流程说明.md
