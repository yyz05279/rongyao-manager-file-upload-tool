# 上传未登录问题修复说明

## 🐛 问题描述

用户已经登录成功，但点击"开始上传"按钮时提示：

```
未登录，请先登录
```

## 🔍 问题原因

### 根本原因

`UploadService` 类在初始化时创建了一个新的 `AuthService()` 实例，而这个新实例没有 token。

**问题代码**：

```python
class UploadService:
    def __init__(self):
        self.auth_service = AuthService()  # ❌ 新实例，没有token

    def upload_daily_report_excel(self, ...):
        if not self.auth_service.is_logged_in():  # ❌ 检查失败
            raise Exception('未登录，请先登录')
```

### 问题分析

- 主窗口和登录界面使用的是另一个 `AuthService` 实例（有 token）
- `UploadService` 创建的是全新实例（无 token）
- 两个实例互不共享数据
- 导致登录状态检查失败

## ✅ 解决方案

### 修改思路

将 `UploadService` 改为接受 `api_base_url` 和 `token` 作为参数，而不是创建新的 `AuthService` 实例。

### 修改内容

#### 1. 修改 `UploadService` 类

**修改前**：

```python
class UploadService:
    def __init__(self):
        self.auth_service = AuthService()
```

**修改后**：

```python
class UploadService:
    def __init__(self, api_base_url: str = None, token: str = None):
        """
        初始化上传服务

        :param api_base_url: API基础URL
        :param token: 认证Token
        """
        self.api_base_url = api_base_url
        self.token = token
```

#### 2. 修改登录状态检查

**修改前**：

```python
if not self.auth_service.is_logged_in():
    raise Exception('未登录，请先登录')
```

**修改后**：

```python
if not self.token or not self.api_base_url:
    raise Exception('未登录，请先登录')
```

#### 3. 修改 API 调用

**修改前**：

```python
api_base_url = self.auth_service.get_api_base_url()
token = self.auth_service.get_token()
headers = {'Authorization': f'Bearer {token}', ...}
```

**修改后**：

```python
headers = {'Authorization': f'Bearer {self.token}', ...}
import_url = f"{self.api_base_url}/api/v1/daily-reports/batch-import"
```

#### 4. 修改 `UploadThread` 类

**修改前**：

```python
class UploadThread(QThread):
    def __init__(self, file_path: str, project_id: int, reporter_id: int):
        super().__init__()
        self.upload_service = UploadService()
```

**修改后**：

```python
class UploadThread(QThread):
    def __init__(self, file_path: str, project_id: int, reporter_id: int,
                 api_base_url: str, token: str):
        super().__init__()
        self.upload_service = UploadService(api_base_url, token)
```

#### 5. 修改上传界面调用

**修改前**：

```python
def start_upload(self):
    # ...
    self.upload_thread = UploadThread(file_path, project_id, reporter_id)
```

**修改后**：

```python
def start_upload(self):
    # 获取认证信息
    token = self.user_info.get('token') or self.config_service.get_token()
    api_base_url = self.config_service.get_login_info().get('server_url')

    if not token:
        QMessageBox.warning(self, "提示", "登录状态已失效，请重新登录")
        return

    # 创建上传线程时传入认证信息
    self.upload_thread = UploadThread(file_path, project_id, reporter_id,
                                     api_base_url, token)
```

## 📝 修改的文件

1. `services/upload_service.py` - 修改 `UploadService` 类
2. `ui/upload_widget.py` - 修改 `UploadThread` 和 `start_upload` 方法

## 🎯 修复效果

### 修复前

```
用户登录 ✓
点击上传 ✗ → "未登录，请先登录"
```

### 修复后

```
用户登录 ✓
点击上传 ✓ → 正常上传
```

## 🔒 安全性增强

修复后的代码还增加了以下安全检查：

1. **Token 有效性检查**：

   ```python
   if not token:
       QMessageBox.warning(self, "提示", "登录状态已失效，请重新登录")
       return
   ```

2. **双重 Token 获取**：

   ```python
   token = self.user_info.get('token') or self.config_service.get_token()
   ```

   - 优先从 `user_info` 获取（当前会话）
   - 如果没有则从配置文件获取（自动登录场景）

3. **项目信息验证**：
   ```python
   if not self.project_info:
       QMessageBox.warning(self, "提示", "没有项目信息，请重新登录")
       return
   ```

## 🧪 测试建议

1. **正常登录上传测试**

   - 使用账号密码登录
   - 选择文件并点击上传
   - 验证上传成功

2. **自动登录上传测试**

   - 关闭应用
   - 重新打开（自动登录）
   - 选择文件并点击上传
   - 验证上传成功

3. **Token 过期测试**
   - 删除配置文件中的 token
   - 点击上传
   - 验证提示"登录状态已失效"

## 💡 设计改进

### 原设计的问题

- 使用多个 `AuthService` 实例
- 实例之间不共享状态
- 容易出现登录状态不一致

### 改进后的设计

- `UploadService` 接受明确的参数
- 不依赖全局状态或单例
- 更容易测试和维护
- 符合依赖注入原则

## 🚀 后续优化建议

1. **统一认证管理**

   - 考虑使用单例模式管理 `AuthService`
   - 或者使用依赖注入容器

2. **Token 自动刷新**

   - 上传前检查 Token 是否即将过期
   - 自动刷新 Token

3. **错误提示优化**
   - 区分不同的未登录场景
   - 提供更详细的错误信息

---

**修复日期**: 2025-10-23
**影响范围**: 文件上传功能
**优先级**: 高 🔴
**状态**: 已修复 ✅
