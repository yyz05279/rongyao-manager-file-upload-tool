# 📦 应用打包指南

本项目支持两个版本的打包：**Tauri 版本**（推荐）和 **Python 版本**。

---

## 🎯 一、Tauri 版本打包（推荐）

Tauri 可以自动为当前平台打包，体积更小、性能更好。

> ⚠️ **重要提示**：打包必须在目标平台上进行！
>
> - 在 macOS 上只能打包 macOS 版本（.app / .dmg）
> - 在 Windows 上只能打包 Windows 版本（.exe / .msi）
> - Tauri 不支持交叉编译到其他平台

### 1.1 准备工作

#### macOS 环境要求

```bash
# 安装 Xcode Command Line Tools
xcode-select --install

# 安装 Node.js（建议使用 16+）
brew install node

# 安装 Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

#### Windows 环境要求

```powershell
# 1. 安装 Node.js（从官网下载：https://nodejs.org/）

# 2. 安装 Rust（从官网下载：https://rustup.rs/）

# 3. 安装 Microsoft C++ Build Tools
# 下载：https://visualstudio.microsoft.com/visual-cpp-build-tools/
# 安装时选择 "Desktop development with C++"
```

### 1.2 打包步骤

```bash
# 1. 进入 Tauri 目录
cd tauri-app

# 2. 安装依赖（首次打包需要）
npm install

# 3. 打包应用
npm run tauri build
```

### 1.3 打包产物位置

#### macOS 打包产物

```
tauri-app/src-tauri/target/release/bundle/
├── dmg/              # DMG 安装包（推荐分发）
│   └── 熔盐管理文件上传工具_0.1.0_aarch64.dmg  (Apple Silicon)
│   └── 熔盐管理文件上传工具_0.1.0_x64.dmg      (Intel Mac)
└── macos/            # .app 应用包
    └── 熔盐管理文件上传工具.app
```

#### Windows 打包产物

```
tauri-app/src-tauri/target/release/bundle/
├── msi/              # MSI 安装包（推荐分发）
│   └── 熔盐管理文件上传工具_0.1.0_x64_en-US.msi
└── nsis/             # NSIS 安装包（备选）
    └── 熔盐管理文件上传工具_0.1.0_x64-setup.exe
```

### 1.4 测试打包结果

#### macOS

```bash
# 打开 .app 应用
open src-tauri/target/release/bundle/macos/熔盐管理文件上传工具.app

# 或安装 DMG
open src-tauri/target/release/bundle/dmg/
```

#### Windows

```powershell
# 直接运行安装包
.\src-tauri\target\release\bundle\msi\熔盐管理文件上传工具_0.1.0_x64_en-US.msi
```

### 1.5 Tauri 打包优势

✅ **体积小**: 10-20MB（Python 版本 100-150MB）  
✅ **性能好**: 使用原生 Rust 后端  
✅ **跨平台**: 一套代码，多平台打包  
✅ **现代化**: React + Rust 技术栈  
✅ **自动签名**: 支持代码签名和公证

---

## 🐍 二、Python 版本打包（备用）

使用 PyInstaller 打包，适合 Python 开发者。

> ⚠️ **重要提示**：PyInstaller 也必须在目标平台上打包！
>
> - 在 macOS 上只能打包 macOS 版本（.app）
> - 在 Windows 上只能打包 Windows 版本（.exe）
> - 不支持交叉编译

### 2.1 准备工作

```bash
# 进入 Python 目录
cd python-app

# 安装依赖
pip install -r requirements.txt

# 安装 PyInstaller
pip install pyinstaller
```

### 2.2 打包 macOS .app

#### 方法 1: 使用打包脚本（推荐）

```bash
# 运行打包脚本
bash build_macos.sh
```

#### 方法 2: 手动打包

```bash
pyinstaller \
    --name="熔盐管理文件上传工具" \
    --windowed \
    --onefile \
    --clean \
    --noconfirm \
    --add-data "parse_daily_report_excel.py:." \
    --add-data "convert_to_api_format.py:." \
    --hidden-import "PyQt6.QtCore" \
    --hidden-import "PyQt6.QtGui" \
    --hidden-import "PyQt6.QtWidgets" \
    --hidden-import "openpyxl" \
    --hidden-import "requests" \
    --exclude-module "PyQt6.Qt6" \
    main.py
```

#### 打包产物

```
python-app/dist/
└── 熔盐管理文件上传工具.app      # macOS 应用包
```

#### 测试运行

```bash
# 打开应用
open dist/熔盐管理文件上传工具.app

# 如果有问题，在终端直接运行查看错误
dist/熔盐管理文件上传工具.app/Contents/MacOS/熔盐管理文件上传工具
```

### 2.3 打包 Windows .exe

#### 方法 1: 使用打包脚本（推荐）

```batch
REM 在 Windows 系统上运行
build_windows.bat
```

#### 方法 2: 手动打包

```powershell
pyinstaller --onefile ^
    --windowed ^
    --name="熔盐管理文件上传工具" ^
    --clean ^
    main.py
```

#### 打包产物

```
python-app/dist/
└── 熔盐管理文件上传工具.exe      # Windows 可执行文件
```

#### 测试运行

```powershell
# 双击运行或在 PowerShell 中执行
.\dist\熔盐管理文件上传工具.exe
```

### 2.4 Python 打包注意事项

⚠️ **体积较大**: 100-150MB（包含 Python 运行时和依赖）  
⚠️ **首次启动慢**: 需要解压临时文件  
⚠️ **杀毒软件**: 可能被误报，需要添加信任  
⚠️ **路径问题**: 使用 spec 文件确保资源正确打包

---

## 💻 三、跨平台打包方案

由于无法交叉编译，如果您需要同时提供 macOS 和 Windows 版本，有以下几种方案：

### 3.1 方案一：准备两台电脑（推荐）

**最简单可靠的方案**：

- 在 Mac 上打包 macOS 版本
- 在 Windows PC 上打包 Windows 版本

### 3.2 方案二：使用虚拟机

#### 在 Mac 上使用 Windows 虚拟机

```bash
# 1. 安装虚拟机软件
# - Parallels Desktop（推荐，性能好）
# - VMware Fusion
# - VirtualBox（免费）

# 2. 安装 Windows 系统

# 3. 在 Windows 虚拟机中：
# - 安装 Node.js 和 Rust（Tauri）
# - 或安装 Python 和 PyInstaller（Python 版本）
# - 运行打包命令
```

#### 在 Windows 上使用 macOS 虚拟机

```powershell
# ⚠️ 注意：在 Windows 上运行 macOS 虚拟机违反 Apple 许可协议
# 不推荐此方案，建议使用真实 Mac 电脑或云服务
```

### 3.3 方案三：使用 CI/CD 服务（专业方案）

推荐使用 GitHub Actions，可以自动在多平台上打包：

#### 创建 `.github/workflows/build.yml`

```yaml
name: Build Apps

on:
  push:
    tags:
      - "v*" # 当推送版本标签时触发

jobs:
  build-tauri:
    strategy:
      matrix:
        platform: [macos-latest, windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Install dependencies
        run: |
          cd tauri-app
          npm install

      - name: Build Tauri app
        run: |
          cd tauri-app
          npm run tauri build

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.platform }}-app
          path: |
            tauri-app/src-tauri/target/release/bundle/
```

**使用步骤**：

```bash
# 1. 创建上述 workflow 文件
mkdir -p .github/workflows
# 将上面的内容保存到 .github/workflows/build.yml

# 2. 提交并推送代码
git add .github/workflows/build.yml
git commit -m "Add CI/CD workflow"
git push

# 3. 创建版本标签触发自动打包
git tag v1.0.0
git push --tags

# 4. 在 GitHub 的 Actions 页面查看进度
# https://github.com/你的用户名/你的仓库/actions
```

**优势**：

- ✅ 自动化：推送标签自动打包
- ✅ 免费：GitHub Actions 对公开仓库免费
- ✅ 多平台：同时打包 macOS 和 Windows
- ✅ 存档：自动上传打包产物

### 3.4 方案四：使用云服务器

**macOS 云服务器**：

- [MacStadium](https://www.macstadium.com/)（付费）
- [MacinCloud](https://www.macincloud.com/)（按小时计费）
- AWS EC2 Mac 实例（付费）

**Windows 云服务器**：

- Azure Virtual Machines
- AWS EC2 Windows 实例
- 阿里云、腾讯云等

### 3.5 方案对比

| 方案     | 成本    | 难度 | 推荐度     | 适合场景           |
| -------- | ------- | ---- | ---------- | ------------------ |
| 双电脑   | 中-高   | 低   | ⭐⭐⭐⭐⭐ | 有设备资源         |
| 虚拟机   | 低-中   | 中   | ⭐⭐⭐     | 偶尔打包           |
| CI/CD    | 免费-低 | 中   | ⭐⭐⭐⭐⭐ | 频繁发版、团队协作 |
| 云服务器 | 高      | 中   | ⭐⭐       | 没有物理设备       |

### 3.6 推荐方案

**个人开发者**：

- 如果有 Mac：使用虚拟机安装 Windows
- 如果有 Windows：借用朋友的 Mac 或使用云服务

**团队/公司**：

- 使用 GitHub Actions 等 CI/CD 服务（最推荐）
- 准备专门的 Mac 和 Windows 打包机器

---

## 🔧 四、高级配置

### 4.1 自定义应用图标（Tauri）

#### macOS 图标

```bash
# 1. 准备 1024x1024 的 PNG 图标
# 2. 生成 .icns 文件（可使用在线工具或 iconutil）
# 3. 将图标放到：
tauri-app/src-tauri/icons/icon.icns
```

#### Windows 图标

```bash
# 1. 准备 256x256 的 PNG 图标
# 2. 转换为 .ico 文件（可使用在线工具）
# 3. 将图标放到：
tauri-app/src-tauri/icons/icon.ico
```

#### 配置图标

编辑 `tauri-app/src-tauri/tauri.conf.json`:

```json
{
  "bundle": {
    "icon": [
      "icons/32x32.png",
      "icons/128x128.png",
      "icons/icon.icns",
      "icons/icon.ico"
    ]
  }
}
```

### 4.2 修改应用信息（Tauri）

编辑 `tauri-app/src-tauri/tauri.conf.json`:

```json
{
  "productName": "熔盐管理文件上传工具",
  "version": "1.0.0",
  "identifier": "com.molten-salt.upload-tool",
  "bundle": {
    "shortDescription": "熔盐管理文件上传工具",
    "longDescription": "用于上传和管理熔盐项目相关文件的桌面应用程序",
    "copyright": "© 2025 Your Company",
    "category": "Productivity"
  }
}
```

### 4.3 代码签名（macOS）

```bash
# 1. 获取开发者证书
# 前往 https://developer.apple.com 申请

# 2. 配置签名
# 编辑 tauri-app/src-tauri/tauri.conf.json
{
  "bundle": {
    "macOS": {
      "signingIdentity": "Your Developer ID",
      "entitlements": null,
      "provisioningProfile": null
    }
  }
}

# 3. 打包时自动签名
npm run tauri build
```

### 4.4 Windows 代码签名

```powershell
# 1. 购买代码签名证书

# 2. 配置证书
# 编辑 tauri-app/src-tauri/tauri.conf.json
{
  "bundle": {
    "windows": {
      "certificateThumbprint": "YOUR_CERT_THUMBPRINT",
      "digestAlgorithm": "sha256",
      "timestampUrl": "http://timestamp.digicert.com"
    }
  }
}

# 3. 打包时自动签名
npm run tauri build
```

---

## 📋 五、常见问题

### 5.1 Tauri 打包问题

#### Q: 打包失败，提示 "Rust not found"

```bash
# 解决方案：安装 Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.cargo/env
```

#### Q: macOS 打包后无法打开，提示 "来自不明开发者"

```bash
# 解决方案 1：允许任何来源
sudo spctl --master-disable

# 解决方案 2：为单个应用添加信任
xattr -cr /path/to/your.app
```

#### Q: Windows 打包后被杀毒软件拦截

```
解决方案：
1. 为应用添加代码签名证书
2. 或手动添加到杀毒软件白名单
```

### 5.2 Python 打包问题

#### Q: PyInstaller 打包失败，提示找不到模块

```bash
# 解决方案：添加 hidden-import
pyinstaller --hidden-import=模块名 main.py
```

#### Q: macOS 打包后运行闪退

```bash
# 解决方案：检查日志
dist/熔盐管理文件上传工具.app/Contents/MacOS/熔盐管理文件上传工具

# 或使用 Console.app 查看崩溃日志
open /Applications/Utilities/Console.app
```

#### Q: Windows 打包后双击无响应

```powershell
# 解决方案：在命令行运行查看错误
.\dist\熔盐管理文件上传工具.exe

# 或使用 --debug 模式重新打包
pyinstaller --debug all main.py
```

---

## 🚀 六、快速命令参考

### Tauri 版本

```bash
# macOS 打包
cd tauri-app && npm run tauri build

# Windows 打包（在 Windows 上执行）
cd tauri-app && npm run tauri build

# 清理构建缓存
cd tauri-app/src-tauri && cargo clean

# 仅构建前端
cd tauri-app && npm run build
```

### Python 版本

```bash
# macOS 打包
cd python-app && bash build_macos.sh

# Windows 打包（在 Windows 上执行）
cd python-app && build_windows.bat

# 清理构建文件
cd python-app && rm -rf build dist *.spec
```

---

## 📊 两个版本对比

| 特性           | Tauri 版本                    | Python 版本             |
| -------------- | ----------------------------- | ----------------------- |
| **体积**       | ✅ 10-20MB                    | ⚠️ 100-150MB            |
| **启动速度**   | ✅ 快速（<1 秒）              | ⚠️ 较慢（2-5 秒）       |
| **性能**       | ✅ 原生性能                   | 🆗 中等                 |
| **内存占用**   | ✅ 低（50-100MB）             | ⚠️ 高（150-300MB）      |
| **跨平台打包** | ✅ 容易（一键打包）           | 🆗 需要分别在各平台打包 |
| **技术栈**     | React + Rust                  | PyQt6 + Python          |
| **学习曲线**   | 需要了解 Rust                 | ✅ Python 开发者友好    |
| **打包时间**   | 首次较慢（5-10 分钟），后续快 | ✅ 快速（1-3 分钟）     |
| **代码签名**   | ✅ 自动支持                   | 需要手动配置            |
| **自动更新**   | ✅ 内置支持                   | 需要自己实现            |
| **推荐度**     | ⭐⭐⭐⭐⭐（强烈推荐）        | ⭐⭐⭐（备用方案）      |

---

## 🎯 推荐方案

### 推荐使用 Tauri 版本，原因：

1. ✅ **体积小**: 只有 10-20MB，易于分发
2. ✅ **性能好**: 原生性能，启动快速
3. ✅ **现代化**: React + Rust 技术栈，易于维护
4. ✅ **自动打包**: 跨平台一键打包
5. ✅ **自带签名**: 支持代码签名和自动更新

### Python 版本适合：

- 团队只熟悉 Python
- 不想学习 Rust
- 快速原型开发
- 临时使用场景

---

## 📞 获取帮助

- **Tauri 官方文档**: https://tauri.app/v1/guides/building/
- **PyInstaller 文档**: https://pyinstaller.org/en/stable/
- **项目文档**: 查看 `docs/` 目录下的详细文档

---

**最后更新**: 2025-10-26  
**推荐版本**: ⭐ **Tauri 版本** （更小、更快、更现代）
