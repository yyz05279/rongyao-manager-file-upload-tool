# 登录接口优化说明

## 🎯 优化内容

### 1. 自动识别登录类型

根据后端接口要求，系统现在会自动判断输入的是**手机号**还是**用户名**，并发送正确的参数。

#### 接口要求

```json
{
  "username": "string (可选)",
  "phone": "string (可选)",
  "password": "string (必填)"
}
```

- `username` 和 `phone` 都是可选的
- 但必须提供其中一个
- 系统会自动判断并选择正确的字段

### 2. 判断规则

#### 识别为手机号的条件：

1. **中国手机号**：

   - 11 位数字
   - 以 1 开头
   - 例如：`13800138000`, `18612345678`

2. **国际手机号**：
   - 10-15 位数字
   - 可以包含国家代码 `+`
   - 例如：`+8613800138000`

#### 识别为用户名的条件：

- 不符合手机号规则的任何输入
- 例如：`admin`, `user123`, `张三`

### 3. 自动忽略格式字符

系统会自动忽略以下字符（仅用于手机号判断）：

- 空格：`138 0013 8000` → `13800138000`
- 横线：`138-0013-8000` → `13800138000`
- 括号：`(138)0013-8000` → `13800138000`

## 📋 请求数据对比

### 优化前（固定发送 username）

```json
{
  "username": "13800138000", // ❌ 即使是手机号也发送 username
  "password": "123456"
}
```

### 优化后（自动识别）

#### 输入手机号时

```json
{
  "phone": "13800138000", // ✅ 自动识别为手机号
  "password": "123456"
}
```

#### 输入用户名时

```json
{
  "username": "admin", // ✅ 自动识别为用户名
  "password": "123456"
}
```

## 🔍 日志输出

### 手机号登录日志

```
============================================================
【登录请求】
URL: http://42.192.76.234:8081/api/v1/auth/login
登录类型: 手机号
登录账号: 13800138000
密码: ******
请求数据: {'phone': '13800138000', 'password': '******'}
============================================================
```

### 用户名登录日志

```
============================================================
【登录请求】
URL: http://42.192.76.234:8081/api/v1/auth/login
登录类型: 用户名
登录账号: admin
密码: ******
请求数据: {'username': 'admin', 'password': '******'}
============================================================
```

## 🧪 测试用例

### 识别为手机号 ✅

| 输入             | 判断结果 | 发送字段 |
| ---------------- | -------- | -------- |
| `13800138000`    | 手机号   | `phone`  |
| `18612345678`    | 手机号   | `phone`  |
| `15912345678`    | 手机号   | `phone`  |
| `138 0013 8000`  | 手机号   | `phone`  |
| `138-0013-8000`  | 手机号   | `phone`  |
| `+8613800138000` | 手机号   | `phone`  |

### 识别为用户名 ✅

| 输入               | 判断结果 | 发送字段                |
| ------------------ | -------- | ----------------------- |
| `admin`            | 用户名   | `username`              |
| `user123`          | 用户名   | `username`              |
| `张三`             | 用户名   | `username`              |
| `test@example.com` | 用户名   | `username`              |
| `12345`            | 用户名   | `username`              |
| `138001380`        | 用户名   | `username` (不足 11 位) |

## 💡 使用示例

### 场景 1：使用手机号登录

1. 在"用户名/手机号"输入框输入：`13800138000`
2. 在"密码"输入框输入：`123456`
3. 点击"登录"按钮
4. 系统自动识别为**手机号**，发送 `phone` 字段

### 场景 2：使用用户名登录

1. 在"用户名/手机号"输入框输入：`admin`
2. 在"密码"输入框输入：`123456`
3. 点击"登录"按钮
4. 系统自动识别为**用户名**，发送 `username` 字段

## 🔧 技术实现

### 判断逻辑

```python
@staticmethod
def _is_phone_number(value: str) -> bool:
    """判断输入是否是手机号"""
    # 去除空格和特殊字符
    cleaned = re.sub(r'[\s\-()]', '', value)

    # 中国手机号：11位数字，以1开头
    if re.match(r'^1\d{10}$', cleaned):
        return True

    # 国际手机号：可能包含国家代码
    if re.match(r'^\+?\d{10,15}$', cleaned):
        return True

    return False
```

### 请求构建逻辑

```python
# 判断是手机号还是用户名
is_phone = self._is_phone_number(username)

# 构建请求数据
if is_phone:
    data = {
        "phone": username,
        "password": password
    }
else:
    data = {
        "username": username,
        "password": password
    }
```

## 📊 优化效果

### 优化前 ❌

- 只能使用用户名登录
- 手机号登录可能失败
- 需要用户手动区分

### 优化后 ✅

- 支持用户名登录
- 支持手机号登录
- 自动智能识别
- 无需用户关心

## 🎨 UI 更新建议

可以考虑更新 UI 标签文本：

### 优化前

```
用户名：[_____________]
```

### 优化后

```
用户名/手机号：[_____________]
```

这样用户会更清楚可以输入手机号。

## 🚀 测试方法

```bash
# 运行程序
python3 main.py

# 测试手机号登录
# 在UI中输入：13800138000
# 查看终端日志，应该显示：登录类型: 手机号

# 测试用户名登录
# 在UI中输入：admin
# 查看终端日志，应该显示：登录类型: 用户名
```

## 📝 相关文件

| 文件                       | 修改内容                       |
| -------------------------- | ------------------------------ |
| `services/auth_service.py` | 添加 `_is_phone_number()` 方法 |
| `services/auth_service.py` | 修改登录请求构建逻辑           |
| `services/auth_service.py` | 更新日志输出                   |

## 🎯 下一步优化建议

1. **UI 标签更新**：将"用户名"改为"用户名/手机号"
2. **输入提示**：在输入框显示"请输入用户名或手机号"
3. **实时反馈**：输入时显示识别结果（可选）

---

**更新日期**：2025-10-23  
**版本**：v1.1  
**状态**：✅ 已完成
