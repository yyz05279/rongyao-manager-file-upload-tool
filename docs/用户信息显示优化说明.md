# 用户信息显示优化说明

## 修改日期

2025 年 10 月 23 日

## 修改内容

### 1. 移除标题框

**修改前**：

```
┌─ 用户和项目信息 ─────────────┐
│ 用户: 13959141232 | 当前项目: ... │
└─────────────────────────────┘
```

**修改后**：

```
┌─────────────────────────────┐
│ 张三 13959141232 | 当前项目: ... │
└─────────────────────────────┘
```

### 2. 用户信息格式优化

**修改前**：

- 格式：`用户：{name} ({username})` 或 `用户：{username}`
- 显示示例：`用户：13959141232` 或 `用户：张三 (admin)`
- 还会显示角色信息：`| 角色：管理员`

**修改后**：

- 格式：`{姓名} {手机号}`
- 显示示例：`张三 13959141232`
- 移除了"用户："前缀
- 移除了角色信息
- 简洁明了

## 代码变更

### 1. 用户信息面板结构修改

#### 修改前

```python
def create_user_info_panel(self):
    """创建用户信息面板"""
    group = QGroupBox("用户和项目信息")  # ❌ 使用QGroupBox，有标题框
    group.setStyleSheet("""
        QGroupBox {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            font-weight: bold;
            color: #000000;
        }
        QGroupBox::title {
            color: #000000;
        }
    """)

    layout = QHBoxLayout(group)

    # 用户信息
    self.user_label = QLabel("用户：未登录")  # ❌ 有"用户："前缀
    ...
```

#### 修改后

```python
def create_user_info_panel(self):
    """创建用户信息面板"""
    # ✅ 使用普通Widget代替QGroupBox，移除标题框
    panel = QWidget()
    panel.setStyleSheet("""
        QWidget {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
        }
    """)

    # 使用水平布局，将用户信息和项目信息放在同一行
    layout = QHBoxLayout(panel)
    layout.setContentsMargins(15, 15, 15, 15)

    # ✅ 用户信息，移除前缀
    self.user_label = QLabel("未登录")
    ...

    return panel
```

**关键改动**：

1. ✅ `QGroupBox` → `QWidget`（移除标题框）
2. ✅ 移除 QGroupBox::title 样式
3. ✅ 移除"用户："前缀
4. ✅ 显式设置边距 `layout.setContentsMargins(15, 15, 15, 15)`

### 2. 用户信息显示逻辑修改

#### 修改前

```python
def set_user_info(self, user_info: dict, project_info: dict = None):
    """设置用户信息和项目信息"""
    ...

    # 显示用户信息
    # 优先显示姓名，如果没有则显示用户名
    name = user_info.get('name')
    username = user_info.get('username', '未知用户')
    role = user_info.get('role', '')

    # ❌ 构建显示文本：用户：{name} ({username})
    if name and name != username:
        display_text = f"用户：{name} ({username})"
    else:
        display_text = f"用户：{username}"

    # ❌ 添加角色信息
    role_map = {
        'ADMIN': '管理员',
        'MANAGER': '项目经理',
        'OPERATOR': '运维人员'
    }
    role_text = role_map.get(role, role)
    if role_text:
        display_text += f" | 角色：{role_text}"

    self.user_label.setText(display_text)
    ...
```

#### 修改后

```python
def set_user_info(self, user_info: dict, project_info: dict = None):
    """设置用户信息和项目信息"""
    ...

    # ✅ 显示用户信息：姓名 + 手机号
    name = user_info.get('name', '未知用户')
    phone = user_info.get('phone') or user_info.get('username', '')

    # ✅ 构建显示文本：{姓名} {手机号}
    if phone:
        display_text = f"{name} {phone}"
    else:
        display_text = name

    self.user_label.setText(display_text)
    ...
```

**关键改动**：

1. ✅ 移除"用户："前缀
2. ✅ 移除角色信息显示
3. ✅ 格式改为：`{姓名} {手机号}`
4. ✅ 优先使用 `phone` 字段，如果没有则使用 `username`
5. ✅ 如果没有手机号，只显示姓名

## 用户信息字段说明

### 字段获取优先级

| 显示内容 | 字段获取优先级                   | 示例          |
| -------- | -------------------------------- | ------------- |
| 姓名     | `name`                           | "张三"        |
| 手机号   | `phone` → `username`（后备方案） | "13959141232" |

### 数据来源

- `name`：用户姓名，来自登录接口返回
- `phone`：手机号，来自登录接口返回
- `username`：用户名，作为手机号的后备方案

### 显示规则

1. **标准情况**：`{姓名} {手机号}`

   - 示例：`张三 13959141232`

2. **没有手机号**：只显示 `{姓名}`

   - 示例：`张三`

3. **没有姓名**：显示 `未知用户 {手机号}`
   - 示例：`未知用户 13959141232`

## 视觉效果对比

### 修改前

```
┌─ 用户和项目信息 ─────────────────────────────────┐
│ 用户：张三 (admin) | 角色：管理员 | 当前项目: 小目标测试项目 │
└─────────────────────────────────────────────────┘
```

- ❌ 有标题框，占用空间
- ❌ 信息冗余（用户名、角色）
- ❌ 格式复杂

### 修改后

```
┌─────────────────────────────────────────────────┐
│ 张三 13959141232 | 当前项目: 小目标测试项目        │
└─────────────────────────────────────────────────┘
```

- ✅ 无标题框，界面更简洁
- ✅ 信息精简（姓名+手机号）
- ✅ 格式清晰易读

## 优势

### 1. 界面更简洁

- 移除了标题框，减少视觉干扰
- 信息一目了然

### 2. 信息更实用

- 姓名+手机号是最常用的用户识别信息
- 移除了不太需要的角色信息

### 3. 空间利用更好

- 减少了标题框的垂直空间占用
- 为其他内容留出更多空间

### 4. 格式更友好

- 符合日常习惯：`姓名 手机号`
- 易于快速识别用户身份

## 修改文件

### 已修改

- `ui/upload_widget.py` - 上传界面

### 修改方法

- `create_user_info_panel()` - 用户信息面板创建
- `set_user_info()` - 用户信息设置

## 注意事项

1. **兼容性**

   - 如果没有 `phone` 字段，会使用 `username` 作为后备
   - 确保向后兼容

2. **数据完整性**

   - 建议登录接口返回完整的用户信息（包括 `name` 和 `phone`）
   - 如果数据不完整，会显示默认值

3. **样式保持**
   - 保持了原有的背景色和边框样式
   - 只是移除了标题框

## 测试建议

1. **正常情况**

   - 验证显示格式：`姓名 手机号`
   - 示例：`张三 13959141232`

2. **边界情况**

   - 测试没有手机号的情况
   - 测试没有姓名的情况
   - 测试字段为空的情况

3. **视觉效果**
   - 确认标题框已移除
   - 确认信息显示清晰
   - 确认与项目信息对齐良好
