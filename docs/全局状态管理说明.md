# 全局状态管理说明

## 📋 功能概述

实现了全局状态管理系统，使用单例模式统一管理项目信息和用户信息，在日报详情对话框中显示完整的项目信息。

## ✨ 实现的功能

### 1. 全局状态管理类

**文件位置**：`services/app_state.py`

**设计模式**：单例模式（Singleton Pattern）

**核心功能**：

- ✅ 全局存储项目信息
- ✅ 全局存储用户信息
- ✅ 统一状态访问接口
- ✅ 状态清空功能

**类结构**：

```python
class AppState:
    """应用全局状态管理类（单例）"""

    # 单例实例
    _instance = None

    # 核心方法
    def set_project_info(project_info: dict)  # 设置项目信息
    def get_project_info() -> dict            # 获取项目信息
    def set_user_info(user_info: dict)        # 设置用户信息
    def get_user_info() -> dict               # 获取用户信息
    def clear()                               # 清空所有状态
    def has_project_info() -> bool            # 是否有项目信息
    def has_user_info() -> bool               # 是否有用户信息
```

### 2. 单例模式实现

**特点**：

- 全局唯一实例
- 线程安全
- 延迟初始化

**实现代码**：

```python
def __new__(cls):
    if cls._instance is None:
        cls._instance = super().__new__(cls)
        cls._instance._initialized = False
    return cls._instance

def __init__(self):
    """初始化"""
    if self._initialized:
        return

    self._initialized = True
    self._project_info = None
    self._user_info = None
```

**使用方式**：

```python
# 在任何地方创建实例，都会返回同一个对象
app_state1 = AppState()
app_state2 = AppState()

# app_state1 和 app_state2 是同一个对象
assert app_state1 is app_state2  # True
```

### 3. 主窗口集成

**文件位置**：`ui/main_window.py`

**修改内容**：

#### 导入全局状态

```python
from services.app_state import AppState
```

#### 初始化全局状态

```python
def __init__(self):
    super().__init__()
    self.auth_service = AuthService()
    self.config_service = ConfigService()
    self.app_state = AppState()  # 全局状态管理
    # ...
```

#### 保存项目信息到全局状态

```python
def fetch_project_info(self):
    """获取项目信息"""
    try:
        # 获取项目信息
        project_service = ProjectService(api_base_url, token)
        self.project_info = project_service.get_my_project()

        # 保存到全局状态
        self.app_state.set_project_info(self.project_info)

        print("✅ 项目信息获取成功\n")
    except Exception as e:
        print(f"❌ 获取项目信息失败: {e}\n")
        self.project_info = None
```

#### 退出登录时清空状态

```python
def on_logout(self):
    """退出登录处理"""
    # ...
    self.app_state.clear()  # 清空全局状态
    # ...
```

### 4. 详情对话框集成

**文件位置**：`ui/daily_report_detail_dialog.py`

**修改内容**：

#### 导入全局状态

```python
from services.app_state import AppState
```

#### 在构造函数中获取项目信息

```python
def __init__(self, report_data: dict, parent=None):
    super().__init__(parent)
    self.report_data = report_data
    self.app_state = AppState()  # 获取全局状态
    self.project_info = self.app_state.get_project_info()  # 获取项目信息
    self.setup_ui()
```

#### 显示项目信息

```python
# 项目名称（优先从全局状态获取）
project_name = self.report_data.get('projectName', '-')
if self.project_info:
    project_name = self.project_info.get('name', project_name)
row1.addWidget(self._create_info_label("📁 项目:", project_name))

# 项目类型和状态
if self.project_info:
    project_type = self.project_info.get('typeDisplayName', '-')
    project_status = self.project_info.get('statusDisplayName', '-')
    row1_extra.addWidget(self._create_info_label("🏷️ 类型:", project_type))
    row1_extra.addWidget(self._create_info_label("📊 状态:", project_status))

# 项目经理和完成度
if self.project_info:
    manager = self.project_info.get('manager', '-')
    completion_progress = self.project_info.get('completionProgress', 0)
    row5.addWidget(self._create_info_label("👨‍💼 项目经理:", manager))
    row5.addWidget(self._create_info_label("📈 项目完成度:", f"{completion_progress}%"))

# 熔盐量信息
if self.project_info:
    estimated_salt = self.project_info.get('estimatedSaltAmount', 0)
    actual_salt = self.project_info.get('actualSaltAmount', 0)
    row6.addWidget(self._create_info_label("🎯 计划熔盐量:", f"{estimated_salt} 吨"))
    row6.addWidget(self._create_info_label("✅ 实际熔盐量:", f"{actual_salt} 吨"))
```

## 📊 数据流向图

```
┌─────────────────────────────────────────────────────┐
│                    启动流程                         │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │   MainWindow.__init__  │
            │   创建 AppState 实例    │
            └────────────────────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │   try_auto_login()     │
            │   或 on_login_success()│
            └────────────────────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │  fetch_project_info()  │
            │  调用 API 获取项目信息  │
            └────────────────────────┘
                         │
                         ▼
            ┌────────────────────────┐
            │ app_state.set_project_ │
            │ info(project_info)     │
            │ 保存到全局状态          │
            └────────────────────────┘
                         │
                         ▼
         ┌──────────────────────────────┐
         │    用户操作：双击日报预览     │
         └──────────────────────────────┘
                         │
                         ▼
         ┌──────────────────────────────┐
         │ DailyReportDetailDialog      │
         │ 创建对话框实例                │
         └──────────────────────────────┘
                         │
                         ▼
         ┌──────────────────────────────┐
         │ app_state = AppState()       │
         │ project_info = app_state.    │
         │ get_project_info()           │
         │ 从全局状态获取项目信息         │
         └──────────────────────────────┘
                         │
                         ▼
         ┌──────────────────────────────┐
         │ 在对话框中显示项目信息：       │
         │ - 项目名称                    │
         │ - 项目类型                    │
         │ - 项目状态                    │
         │ - 项目经理                    │
         │ - 完成度                      │
         │ - 熔盐量                      │
         └──────────────────────────────┘
```

## 🎯 项目信息字段

从 `my-projects` API 获取的项目信息包含以下字段：

| 字段名                | 说明               | 类型   | 示例             |
| --------------------- | ------------------ | ------ | ---------------- |
| `id`                  | 项目 ID            | int    | 9                |
| `name`                | 项目名称           | string | "小目标测试项目" |
| `type`                | 项目类型（原始值） | string | "binary"         |
| `typeDisplayName`     | 项目类型（显示名） | string | "二元化盐项目"   |
| `status`              | 项目状态（原始值） | string | "in_progress"    |
| `statusDisplayName`   | 项目状态（显示名） | string | "进行中"         |
| `manager`             | 项目经理           | string | "徐经理"         |
| `managerId`           | 项目经理 ID        | int    | 10               |
| `contactPhone`        | 联系电话           | string | "13959141232"    |
| `estimatedSaltAmount` | 计划熔盐量（吨）   | float  | 50.00            |
| `actualSaltAmount`    | 实际熔盐量（吨）   | float  | 550.00           |
| `completionProgress`  | 完成进度（%）      | float  | 999.99           |
| `remainingSaltAmount` | 剩余熔盐量（吨）   | float  | 0.00             |
| `startDate`           | 开始日期           | string | "2025-09-30"     |
| `endDate`             | 计划结束日期       | string | "2025-12-31"     |
| `finishDate`          | 实际完成日期       | string | "2025-10-17"     |
| `description`         | 项目描述           | string | "小目标测试"     |

## 📱 界面展示

### 日报详情对话框 - 基本信息面板

```
┌─────────────────────────────────────────────────────┐
│  基本信息                                           │
├─────────────────────────────────────────────────────┤
│                                                     │
│  📅 日期: 2025.10.1      📁 项目: 小目标测试项目     │
│                                                     │
│  🏷️ 类型: 二元化盐项目    📊 状态: 进行中           │
│                                                     │
│  🎯 进度状态: 正常🟢                                 │
│                                                     │
│  📝 进度描述: 二期项目初始阶段                       │
│                                                     │
│  📋 任务数: 3   👷 人员数: 15   🚜 机械数: 2   ⚠️ 问题数: 1│
│                                                     │
│  ☀️ 天气: 晴    🌡️ 温度: 25°C                       │
│                                                     │
│  👨‍💼 项目经理: 徐经理   📈 项目完成度: 999.99%      │
│                                                     │
│  🎯 计划熔盐量: 50.0 吨   ✅ 实际熔盐量: 550.0 吨    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## 💡 技术优势

### 1. 单例模式的好处

**避免重复创建**：

```python
# 不需要单例时
project_info = fetch_project_info()  # 每次都要调用API
dialog1 = Dialog(project_info)
dialog2 = Dialog(project_info)  # 需要手动传递

# 使用单例后
app_state.set_project_info(project_info)  # 只设置一次
dialog1 = Dialog()  # 自动获取
dialog2 = Dialog()  # 自动获取
```

**全局访问**：

```python
# 在任何地方都可以访问
class AnyWidget:
    def __init__(self):
        app_state = AppState()
        project_info = app_state.get_project_info()
        # 使用项目信息
```

**状态同步**：

```python
# 所有地方看到的都是最新状态
app_state.set_project_info(new_info)

# 所有组件自动获取最新信息
widget1 = SomeWidget()  # 获取到 new_info
widget2 = AnotherWidget()  # 也是 new_info
```

### 2. 解耦合

**修改前**：

```python
# 需要层层传递
MainWindow -> UploadWidget -> Dialog(project_info)
```

**修改后**：

```python
# 直接从全局状态获取
MainWindow -> app_state.set_project_info()
Dialog -> app_state.get_project_info()
```

### 3. 易于维护

**添加新字段**：

```python
# 只需要在 AppState 中添加
def set_config(self, config: dict):
    self._config = config

def get_config(self) -> dict:
    return self._config
```

**使用新字段**：

```python
# 任何地方都可以使用
app_state = AppState()
config = app_state.get_config()
```

## 🔧 使用指南

### 1. 设置项目信息

**在主窗口中**：

```python
def fetch_project_info(self):
    """获取项目信息"""
    project_service = ProjectService(api_base_url, token)
    project_info = project_service.get_my_project()

    # 保存到全局状态
    self.app_state.set_project_info(project_info)
```

### 2. 获取项目信息

**在任何组件中**：

```python
def __init__(self):
    self.app_state = AppState()
    self.project_info = self.app_state.get_project_info()

    if self.project_info:
        project_name = self.project_info.get('name', '-')
        # 使用项目信息
```

### 3. 清空状态

**退出登录时**：

```python
def on_logout(self):
    """退出登录"""
    self.app_state.clear()  # 清空所有全局状态
```

### 4. 检查状态

**判断是否有项目信息**：

```python
if self.app_state.has_project_info():
    # 显示项目相关内容
    self.show_project_info()
else:
    # 显示默认内容或提示
    self.show_default_info()
```

## 📝 注意事项

### 1. 线程安全

当前实现是单线程安全的，如果需要多线程访问，需要添加锁：

```python
import threading

class AppState:
    _instance = None
    _lock = threading.Lock()

    def __new__(cls):
        if cls._instance is None:
            with cls._lock:
                if cls._instance is None:
                    cls._instance = super().__new__(cls)
        return cls._instance
```

### 2. 状态持久化

当前实现是内存状态，应用关闭后会丢失。如果需要持久化，可以结合 `ConfigService`：

```python
def set_project_info(self, project_info: dict):
    """设置项目信息并持久化"""
    self._project_info = project_info
    # 可选：保存到配置文件
    # self.config_service.save_project_info(project_info)
```

### 3. 状态更新时机

- ✅ 登录成功后立即更新
- ✅ Token 刷新后需要重新获取
- ✅ 退出登录时清空状态
- ❌ 不要在界面初始化时就访问（可能还没登录）

### 4. 空值检查

始终检查返回值是否为 `None`：

```python
project_info = app_state.get_project_info()

if project_info:
    # 使用项目信息
    project_name = project_info.get('name', '未知项目')
else:
    # 处理没有项目信息的情况
    project_name = '未登录'
```

## 🚀 扩展建议

### 1. 添加观察者模式

当状态改变时通知所有观察者：

```python
class AppState:
    def __init__(self):
        self._observers = []

    def add_observer(self, callback):
        """添加观察者"""
        self._observers.append(callback)

    def set_project_info(self, project_info: dict):
        """设置项目信息"""
        self._project_info = project_info
        self._notify_observers('project_info', project_info)

    def _notify_observers(self, key, value):
        """通知所有观察者"""
        for callback in self._observers:
            callback(key, value)
```

**使用**：

```python
def on_project_changed(key, value):
    print(f"项目信息已更新: {value}")

app_state.add_observer(on_project_changed)
```

### 2. 添加状态历史

记录状态变化历史：

```python
class AppState:
    def __init__(self):
        self._history = []

    def set_project_info(self, project_info: dict):
        """设置项目信息"""
        self._history.append({
            'timestamp': datetime.now(),
            'key': 'project_info',
            'value': project_info
        })
        self._project_info = project_info

    def get_history(self):
        """获取历史记录"""
        return self._history
```

### 3. 添加状态验证

验证数据有效性：

```python
def set_project_info(self, project_info: dict):
    """设置项目信息"""
    if not isinstance(project_info, dict):
        raise ValueError("project_info must be a dict")

    required_fields = ['id', 'name']
    for field in required_fields:
        if field not in project_info:
            raise ValueError(f"Missing required field: {field}")

    self._project_info = project_info
```

## 📊 性能考虑

### 内存占用

- ✅ 单例模式只创建一个实例，内存占用小
- ✅ 只存储必要的数据（项目信息、用户信息）
- ✅ 退出登录时清空数据，释放内存

### 访问速度

- ✅ 直接内存访问，速度极快（纳秒级）
- ✅ 不需要网络请求，无延迟
- ✅ 适合频繁访问的场景

## 🎯 总结

### 核心改进

1. ✅ 创建了全局状态管理类 `AppState`
2. ✅ 使用单例模式确保全局唯一实例
3. ✅ 在主窗口中保存项目信息到全局状态
4. ✅ 在详情对话框中从全局状态获取并显示项目信息
5. ✅ 显示完整的项目详细信息（类型、状态、经理、完成度、熔盐量等）

### 用户收益

1. 📊 **信息更全面**：在日报详情中查看完整的项目信息
2. 🎯 **体验更好**：无需额外操作，自动显示项目信息
3. 💡 **上下文清晰**：了解当前日报所属的项目背景

### 技术优势

1. 🏗️ **架构清晰**：统一的全局状态管理
2. 🔧 **易于维护**：解耦合，便于扩展
3. 🚀 **性能优秀**：内存访问，速度快
4. 📦 **代码复用**：任何地方都可以访问全局状态

---

**更新日期**: 2025-10-23  
**版本**: v2.6  
**状态**: ✅ 已完成
