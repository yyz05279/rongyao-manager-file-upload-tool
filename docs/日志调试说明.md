# 日志调试说明

## 📋 已添加的日志功能

为了帮助定位登录问题，已在关键位置添加详细的日志输出。

### 日志输出位置

#### 1. UI 层 - 登录按钮点击

**文件**: `ui/login_widget.py`

```
============================================================
【UI层】登录按钮点击
服务器: http://42.192.76.234:8081
用户名: admin
密码长度: 8
============================================================
```

#### 2. 登录线程 - 开始执行

**文件**: `ui/login_widget.py`

```
============================================================
【登录线程】开始执行
============================================================
```

#### 3. 服务层 - 登录请求

**文件**: `services/auth_service.py`

```
============================================================
【登录请求】
URL: http://42.192.76.234:8081/api/v1/auth/login
用户名: admin
密码: ********
请求数据: {'username': 'admin', 'password': '12345678'}
============================================================
```

#### 4. 服务层 - 登录响应

**文件**: `services/auth_service.py`

```
============================================================
【登录响应】
状态码: 200
响应头: {'Content-Type': 'application/json', ...}
响应内容: {"code":200,"message":"success",...}
============================================================
```

#### 5. 详细处理过程

**文件**: `services/auth_service.py`

- ✅ JSON 解析成功
- ✅ 登录成功
- ❌ HTTP 状态码错误
- ❌ 业务状态码错误
- ❌ Token 缺失
- ❌ 连接超时
- ❌ 连接错误
- ❌ 网络请求异常
- ❌ 未知错误

## 🔍 如何使用日志调试

### 步骤 1：在终端运行程序

```bash
cd "/Users/yyz/Desktop/熔盐管理文件上传工具"
python3 main.py
```

### 步骤 2：尝试登录

1. 输入服务器地址
2. 输入用户名
3. 输入密码
4. 点击"登录"按钮

### 步骤 3：查看终端日志

终端会输出详细的日志信息，按顺序显示：

```
============================================================
【UI层】登录按钮点击
服务器: http://42.192.76.234:8081
用户名: admin
密码长度: 8
============================================================

🚀 开始登录流程...

============================================================
【登录线程】开始执行
============================================================

============================================================
【登录请求】
URL: http://42.192.76.234:8081/api/v1/auth/login
用户名: admin
密码: ********
请求数据: {'username': 'admin', 'password': '12345678'}
============================================================

============================================================
【登录响应】
状态码: 404
响应头: {'Content-Type': 'text/html', ...}
响应内容: <!DOCTYPE html>...
============================================================

❌ HTTP状态码错误: 404
错误信息: HTTP 404

❌ 登录线程失败: HTTP 404
异常类型: Exception

============================================================
【UI层】登录失败
错误信息: HTTP 404
============================================================

🔄 登录流程结束，恢复按钮状态
```

## 🎯 根据日志诊断问题

### 问题 1：连接失败

**日志显示：**

```
❌ 连接错误
详细信息: HTTPConnectionPool(host='42.192.76.234', port=8081):
Max retries exceeded...
```

**原因：**

- 服务器未运行
- 服务器地址错误
- 网络不通

**解决：**

1. 检查服务器是否启动
2. 确认服务器地址正确
3. 测试网络连接：`ping 42.192.76.234`

### 问题 2：404 错误

**日志显示：**

```
状态码: 404
❌ HTTP状态码错误: 404
```

**原因：**

- API 路径错误
- 服务器端没有这个接口

**解决：**

1. 检查 API 路径是否为 `/api/v1/auth/login`
2. 确认后端接口是否已部署
3. 用 curl 测试接口：
   ```bash
   curl -X POST http://42.192.76.234:8081/api/v1/auth/login \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","password":"12345678"}'
   ```

### 问题 3：401 未授权

**日志显示：**

```
状态码: 401
响应内容: {"code":401,"message":"用户名或密码错误"}
```

**原因：**

- 用户名或密码错误

**解决：**

1. 检查用户名是否正确
2. 检查密码是否正确
3. 确认账号是否存在

### 问题 4：业务状态码错误

**日志显示：**

```
✅ JSON解析成功
响应结构: {'code': 401, 'message': '用户名或密码错误'}
❌ 业务状态码错误: 401
```

**原因：**

- 后端返回的业务错误

**解决：**

- 查看 `message` 字段的错误信息
- 根据错误信息修正

### 问题 5：Token 缺失

**日志显示：**

```
✅ JSON解析成功
❌ Token缺失
返回数据: {'id': 1, 'username': 'admin'}
```

**原因：**

- 后端未返回 token 字段

**解决：**

- 检查后端登录接口是否返回 token
- 确认响应格式是否正确

## 📊 日志级别说明

### 符号含义

- 🚀 **开始** - 流程开始
- ✅ **成功** - 操作成功
- ❌ **错误** - 操作失败
- ⚠️ **警告** - 输入验证警告
- 🔄 **完成** - 流程结束

### 日志颜色（在终端中）

- **绿色** ✅ - 成功信息
- **红色** ❌ - 错误信息
- **黄色** ⚠️ - 警告信息
- **蓝色** 🚀 - 流程信息

## 🛠️ 调试技巧

### 1. 完整的日志输出

运行程序并将日志保存到文件：

```bash
python3 main.py 2>&1 | tee login_debug.log
```

### 2. 只查看错误信息

```bash
python3 main.py 2>&1 | grep -E "❌|错误"
```

### 3. 测试 API 接口

使用 curl 直接测试后端接口：

```bash
# 测试登录接口
curl -v -X POST http://42.192.76.234:8081/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"12345678"}'
```

### 4. 检查网络连通性

```bash
# 测试服务器是否可达
ping 42.192.76.234

# 测试端口是否开放
telnet 42.192.76.234 8081
# 或
nc -zv 42.192.76.234 8081
```

## 📝 常见登录问题排查

### 检查清单

- [ ] 服务器地址是否正确
- [ ] 服务器是否运行
- [ ] 网络是否连通
- [ ] 端口是否开放
- [ ] API 路径是否正确
- [ ] 用户名是否正确
- [ ] 密码是否正确
- [ ] 后端接口是否正常

### 完整的排查流程

1. **检查日志中的 URL**

   ```
   URL: http://42.192.76.234:8081/api/v1/auth/login
   ```

   确认地址、端口、路径都正确

2. **检查状态码**

   - 200: 成功（继续检查业务码）
   - 404: 接口不存在
   - 401: 未授权
   - 500: 服务器错误
   - 连接错误: 服务器未启动或网络不通

3. **检查响应内容**

   - JSON 格式是否正确
   - code 字段是否为 200
   - data 字段是否包含 token

4. **检查 Token**
   ```
   Token: eyJhbGciOiJIUzI1NiIs...
   ```
   确认 Token 已返回

## 🎯 现在就试试

```bash
# 在终端运行并查看详细日志
python3 main.py
```

所有关键步骤都会有详细的日志输出，帮助您快速定位问题！

---

**添加日期**：2025-10-23  
**日志位置**：所有日志都输出到终端（标准输出）  
**状态**：✅ 已完成
