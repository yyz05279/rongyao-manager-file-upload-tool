# 项目信息调试日志说明

## 问题描述

用户反馈登录后项目信息没有展示，为了调试问题，在关键位置添加了详细的日志。

## 日志位置

### 前端日志（浏览器控制台）

#### 1. LoginForm.jsx - 登录流程

```javascript
// 登录开始
🔐 [LoginForm] 开始登录...

// 登录成功
✅ [LoginForm] 登录成功

// 开始获取项目信息
📋 [LoginForm] 开始获取项目信息...

// 项目信息获取成功
✅ [LoginForm] 项目信息已获取: {项目信息对象}

// 项目信息获取失败
⚠️ [LoginForm] 获取项目信息失败: {错误信息}
```

#### 2. authStore.js - 状态管理

```javascript
// 开始获取项目信息
🔍 [authStore] 开始获取项目信息...

// 项目信息获取成功
✅ [authStore] 项目信息获取成功: {项目信息对象}

// 项目信息获取失败
❌ [authStore] 项目信息获取失败: {错误信息}
```

#### 3. UploadForm.jsx - 上传页面

```javascript
// useEffect 检查项目信息
🔍 [UploadForm] useEffect 检查项目信息, projectInfo: {当前projectInfo}

// 项目信息为空，开始获取
📋 [UploadForm] 项目信息为空，开始获取...

// 项目信息获取成功
✅ [UploadForm] 项目信息获取成功: {项目信息对象}

// 项目信息获取失败
⚠️ [UploadForm] 获取项目信息失败: {错误信息}

// 项目信息已存在
✅ [UploadForm] 项目信息已存在: {项目信息对象}

// projectInfo 状态更新
📊 [UploadForm] projectInfo 状态更新: {
  hasProjectInfo: true/false,
  projectInfo: {项目信息对象}
}
```

#### 4. ReportDetailDialog.jsx - 详情弹窗

```javascript
// 打开详情弹窗
📋 [ReportDetailDialog] 打开详情弹窗
  - report: {日报数据}
  - projectInfo: {项目信息对象}
```

### 后端日志（终端输出）

#### 1. main.rs - Tauri 命令

```rust
// cmd_get_project 被调用
🔍 [cmd_get_project] Tauri命令被调用

// Token为空
❌ [cmd_get_project] Token为空，用户未登录

// Token已获取
✅ [cmd_get_project] Token已获取

// 项目信息获取成功
✅ [cmd_get_project] 项目信息获取成功: ProjectInfo { ... }

// 项目信息获取失败
❌ [cmd_get_project] 项目信息获取失败: {错误信息}
```

#### 2. project.rs - 项目服务

```rust
// 开始获取项目信息
🔍 [ProjectService] 开始获取项目信息
  - URL: http://42.192.76.234:8081/api/v1/projects/my-project
  - Token: {前20个字符}

// 请求失败
❌ [ProjectService] 请求失败: {错误信息}

// 响应状态
📡 [ProjectService] 响应状态: {HTTP状态码}

// 获取项目信息失败
❌ [ProjectService] 获取项目信息失败，状态码: {状态码}

// 解析数据失败
❌ [ProjectService] 解析数据失败: {错误信息}

// API响应数据
📦 [ProjectService] API响应数据: {完整的JSON响应}

// 项目信息解析成功
✅ [ProjectService] 项目信息解析成功: ProjectInfo { ... }
```

## 调试步骤

### 1. 重新启动应用

```bash
# 停止当前运行的应用（Ctrl+C）
# 重新启动
cd tauri-app
npm run tauri dev
```

### 2. 打开浏览器控制台

在应用窗口中按 `F12` 或右键选择"检查元素"打开开发者工具。

### 3. 查看终端日志

在启动应用的终端窗口中查看后端日志输出。

### 4. 登录测试

1. 输入用户名和密码
2. 点击登录
3. 观察日志输出

**预期日志流程**：

**前端（浏览器控制台）**：

```
🔐 [LoginForm] 开始登录...
✅ [LoginForm] 登录成功
📋 [LoginForm] 开始获取项目信息...
🔍 [authStore] 开始获取项目信息...
```

**后端（终端）**：

```
🔍 [cmd_get_project] Tauri命令被调用
✅ [cmd_get_project] Token已获取
🔍 [ProjectService] 开始获取项目信息
  - URL: http://42.192.76.234:8081/api/v1/projects/my-project
  - Token: eyJhbGciOiJIUzI1NiIs...
📡 [ProjectService] 响应状态: 200 OK
📦 [ProjectService] API响应数据: {
  "code": 1,
  "msg": "success",
  "data": { ... }
}
✅ [ProjectService] 项目信息解析成功: ProjectInfo { id: 1, name: "淮安", ... }
```

**前端（继续）**：

```
✅ [authStore] 项目信息获取成功: {id: 1, name: "淮安", ...}
✅ [LoginForm] 项目信息已获取: {id: 1, name: "淮安", ...}
🔍 [UploadForm] useEffect 检查项目信息, projectInfo: {id: 1, name: "淮安", ...}
✅ [UploadForm] 项目信息已存在: {id: 1, name: "淮安", ...}
📊 [UploadForm] projectInfo 状态更新: {hasProjectInfo: true, projectInfo: {...}}
```

## 可能的错误情况

### 错误 1：Token 为空

**日志**：

```
❌ [cmd_get_project] Token为空，用户未登录
```

**原因**：登录时 Token 没有正确保存到全局状态

**检查**：

1. 查看登录接口是否返回了 Token
2. 检查 authStore 中 Token 是否正确保存

### 错误 2：API 请求失败

**日志**：

```
❌ [ProjectService] 请求失败: {错误信息}
```

**原因**：网络连接问题或 API 地址错误

**检查**：

1. 确认 API 地址是否正确（http://42.192.76.234:8081）
2. 检查网络连接

### 错误 3：API 返回错误状态码

**日志**：

```
📡 [ProjectService] 响应状态: 401 Unauthorized
❌ [ProjectService] 获取项目信息失败，状态码: 401
```

**原因**：Token 无效或已过期

**检查**：

1. 重新登录获取新的 Token
2. 检查 Token 是否正确传递

### 错误 4：数据解析失败

**日志**：

```
📦 [ProjectService] API响应数据: { ... }
❌ [ProjectService] 解析数据失败: {错误信息}
```

**原因**：API 返回的数据格式与预期不符

**检查**：

1. 查看完整的 API 响应数据
2. 对比 ProjectInfo 结构定义

### 错误 5：项目信息未显示在 UI

**日志**：

```
✅ [authStore] 项目信息获取成功: {...}
📊 [UploadForm] projectInfo 状态更新: {hasProjectInfo: false, projectInfo: null}
```

**原因**：状态管理问题，projectInfo 没有正确传递到 UI

**检查**：

1. 检查 authStore 中 projectInfo 是否正确设置
2. 检查 UploadForm 是否正确订阅了 authStore

## 新增字段

为了完整显示项目信息，ProjectInfo 结构体新增了以下可选字段：

```rust
#[derive(Clone, Serialize, Deserialize, Debug)]
#[serde(rename_all = "camelCase")]
pub struct ProjectInfo {
    pub id: i32,
    pub name: String,
    pub type_display_name: String,
    pub status_display_name: String,
    pub manager: String,

    // ✅ 新增字段
    #[serde(skip_serializing_if = "Option::is_none")]
    pub completion_progress: Option<i32>,

    #[serde(skip_serializing_if = "Option::is_none")]
    pub estimated_salt_amount: Option<i32>,

    #[serde(skip_serializing_if = "Option::is_none")]
    pub actual_salt_amount: Option<i32>,
}
```

这些字段会在详情弹窗中显示：

- `completionProgress` - 项目完成度
- `estimatedSaltAmount` - 计划熔盐量
- `actualSaltAmount` - 实际熔盐量

## UI 更新

### 上传页面

项目信息显示位置：

```jsx
{
  projectInfo ? (
    <span style={{ marginLeft: "20px" }}>
      | 当前项目:{" "}
      <strong style={{ color: "#FFD700" }}>{projectInfo.name}</strong>
    </span>
  ) : (
    <span style={{ marginLeft: "20px", color: "#FF9800" }}>
      | 项目信息加载中...
    </span>
  );
}
```

### 详情弹窗

项目详细信息显示：

- 🏷️ 项目类型
- 📊 项目状态
- 👨‍💼 项目经理
- 📈 项目完成度
- 🎯 计划熔盐量
- ✅ 实际熔盐量

## 总结

通过以上日志，可以完整追踪项目信息获取的全流程：

1. **登录** → LoginForm.jsx
2. **调用 API** → authStore.js → Tauri backend
3. **发送请求** → project.rs
4. **接收响应** → project.rs → Tauri backend
5. **更新状态** → authStore.js
6. **UI 显示** → UploadForm.jsx

如果项目信息没有显示，通过日志可以快速定位问题出在哪个环节。
