# 问题反馈序号格式修复说明

## 修复日期

2025 年 10 月 23 日

## 问题描述

用户反馈 Excel 中有问题反馈数据，但解析后在 UI 中显示"✅ 暂无问题反馈"。

实际情况：

- Excel 中确实有问题数据（序号 2、3）
- 但解析代码用错误的序号格式进行过滤（`startswith("1.")`）
- 导致所有问题反馈数据都被过滤掉

## 根本原因

### Excel 实际结构

```
四      问题反馈
1       问题描述              ← 子标题行
2       现场管道安装进度...    ← 实际问题数据
3       缓冲罐基础下方...      ← 实际问题数据
...
2       需求描述              ← 子标题行（可能）
...     需求内容...           ← 需求数据（可能）
```

### 错误的解析逻辑

```python
# ❌ 错误：使用 "1." 前缀过滤
if description and problem_no.startswith("1."):
    problems.append({...})
```

**问题**：

- Excel 中问题反馈的序号是纯数字：`2`、`3`、`4`...
- 不是 `1.1`、`1.2`、`1.3` 格式
- `startswith("1.")` 过滤条件永远不会匹配
- 导致所有问题数据都被忽略

## Excel 序号体系分析

### 多层序号结构

Excel 使用了**三层序号体系**：

#### 第一层：大区域（中文序号）

- 二：各工种工作汇报
- 三：机械租赁情况
- 四：问题反馈

#### 第二层：进度计划区域（带点序号）

- 2.1、2.2、2.3：逐项进度汇报
- 3.1、3.2、3.3：明日工作计划

#### 第三层：问题反馈子区域（纯数字）

```
四 (大区域)
├── 1 (子标题: 问题描述)
│   ├── 2 (实际问题1)
│   ├── 3 (实际问题2)
│   └── 4 (实际问题3)
└── 2 (子标题: 需求描述)
    ├── ... (需求1)
    └── ... (需求2)
```

**关键发现**：

- "1" 不是数据序号，而是"问题描述"子区域的标题
- "2"、"3"、"4" 才是实际的问题数据序号
- 同样，如果有需求描述，"2"是子标题，后面的才是数据

## 修复方案

### 1. 问题反馈解析修复

```python
def _parse_problem_feedbacks(self, ws, start_row: int, end_row: int) -> List[Dict]:
    """解析问题反馈（区域四 -> 子区域1）"""
    problems = []
    in_target_area = False

    for i in range(start_row, end_row + 1):
        problem_no = self._get_cell_value(ws, i, 1)
        description = self._get_cell_value(ws, i, 2)

        # 检测区域标题"四"
        if problem_no == '四':
            in_target_area = True
            continue

        # 遇到下一个区域标题，停止
        if problem_no in ['五', '六'] and in_target_area:
            break

        # 只在目标区域内解析
        if not in_target_area:
            continue

        # 跳过表头行
        if description in ['问题描述', '问题反馈', '序号']:
            continue

        # ✅ 新增：跳过子标题行（序号为"1"）
        if problem_no == '1':
            continue

        reason = self._get_cell_value(ws, i, 4)
        impact = self._get_cell_value(ws, i, 5)
        progress = self._get_cell_value(ws, i, 6)

        # ✅ 修复：使用纯数字判断，而不是"1."前缀
        if description and problem_no.isdigit():
            problems.append({
                "problemNo": problem_no,
                "description": description,
                "reason": reason,
                "impact": impact,
                "progress": progress
            })

    return problems
```

**修复要点**：

1. ✅ 跳过序号为"1"的子标题行
2. ✅ 使用 `problem_no.isdigit()` 判断纯数字
3. ✅ 不再使用 `startswith("1.")` 错误过滤

### 2. 需求描述解析修复

```python
def _parse_requirements(self, ws, start_row: int, end_row: int) -> List[Dict]:
    """解析需求描述（区域四 -> 子区域2）"""
    requirements = []
    in_target_area = False
    in_requirements_section = False  # ✅ 新增：是否进入需求描述子区域

    for i in range(start_row, end_row + 1):
        req_no = self._get_cell_value(ws, i, 1)
        description = self._get_cell_value(ws, i, 2)

        # 检测区域标题"四"
        if req_no == '四':
            in_target_area = True
            continue

        # 遇到下一个区域标题，停止
        if req_no in ['五', '六'] and in_target_area:
            break

        # 只在目标区域内解析
        if not in_target_area:
            continue

        # ✅ 新增：检测需求描述子标题（序号"2"且内容为"需求描述"）
        if req_no == '2' and description in ['需求描述', '需求']:
            in_requirements_section = True
            continue

        # ✅ 新增：只在需求描述子区域内解析
        if not in_requirements_section:
            continue

        # 跳过表头行
        if description in ['需求描述', '问题反馈', '序号']:
            continue

        urgency_level = self._get_cell_value(ws, i, 4)
        expected_time = self._get_cell_value(ws, i, 6)

        # ✅ 修复：保存有需求描述的记录
        if description:
            requirements.append({
                "requirementNo": req_no,
                "description": description,
                "urgencyLevel": urgency_level,
                "expectedTime": expected_time
            })

    return requirements
```

**修复要点**：

1. ✅ 增加 `in_requirements_section` 标志位
2. ✅ 检测序号"2"且内容为"需求描述"的子标题行
3. ✅ 只在需求描述子区域内解析数据
4. ✅ 不再使用 `startswith("2.")` 错误过滤

## 修复效果对比

### 修复前

```
⚠️ 问题反馈（四）选项卡：

1. 问题反馈
✅ 暂无问题反馈  ← 错误：实际有数据

2. 需求描述
暂无需求描述
```

### 修复后

```
⚠️ 问题反馈（四）选项卡：

1. 问题反馈
序号  问题描述                         原因                 影响              处理进度
2     现场管道安装进度严重滞后...      材料迟迟没加个好...  影响二期化盐进度  明日再催促...
3     缓冲罐基础下方出现局部水土流失   前期硬化时没有做...  缓冲罐一端会有... 尽快联系...

2. 需求描述
（如果有数据会显示）
```

## 序号格式总结

| 区域/子区域    | 序号格式  | 示例          | 过滤方式                         |
| -------------- | --------- | ------------- | -------------------------------- |
| 逐项进度汇报   | X.Y       | 2.1, 2.2, 2.3 | `startswith("2.")`               |
| 明日工作计划   | X.Y       | 3.1, 3.2, 3.3 | `startswith("3.")`               |
| 各工种工作汇报 | 纯数字    | 1, 2, 3...    | 区域"二"内所有数据               |
| 机械租赁情况   | 纯数字    | 1, 2, 3...    | 区域"三"内所有数据               |
| 问题反馈       | 纯数字    | 2, 3, 4...    | 区域"四"内，跳过"1"，`isdigit()` |
| 需求描述       | 纯数字/无 | ...           | 区域"四"内，检测到"2"子标题后    |

**注意**：

- 带点序号（2.1）用于进度和计划区域
- 纯数字序号用于人员、机械、问题反馈区域
- 问题反馈区域的"1"和"2"是子标题，不是数据序号

## 技术要点

### 1. 子标题检测

```python
# 问题描述子标题：序号为"1"
if problem_no == '1':
    continue

# 需求描述子标题：序号为"2"且内容为"需求描述"
if req_no == '2' and description in ['需求描述', '需求']:
    in_requirements_section = True
    continue
```

### 2. 纯数字判断

```python
# 使用 isdigit() 判断纯数字序号
if problem_no.isdigit():
    # 处理数据
```

### 3. 双标志位

```python
in_target_area = False  # 是否在"四"区域内
in_requirements_section = False  # 是否在需求描述子区域内
```

## 修改文件

### 已修改

- `parse_daily_report_excel.py` - Excel 解析器

### 修改方法

- `_parse_problem_feedbacks()` - 修复序号过滤逻辑
- `_parse_requirements()` - 增加子区域检测

## 测试建议

1. **验证问题反馈显示**

   - 使用包含问题反馈的 Excel 测试
   - 确认问题数据正确显示
   - 验证序号 2、3、4 等被正确解析

2. **验证子标题过滤**

   - 确认序号"1"（问题描述）不会作为数据显示
   - 确认序号"2"（需求描述）不会作为数据显示

3. **验证需求描述**

   - 测试包含需求描述的 Excel
   - 确认需求数据正确分组显示

4. **边界情况**
   - 测试只有问题反馈，没有需求描述的情况
   - 测试问题反馈为空的情况
   - 测试序号不连续的情况（2、4、6）

## 与之前修复的关系

### 修复历史

1. **第一次修复**：数据分组过滤（序号前缀 2.x, 3.x）
2. **第二次修复**：中文区域解析（区域标题二、三、四）
3. **第三次修复**：问题反馈序号格式（纯数字 vs 带点序号）

### 完整的过滤机制

现在的解析逻辑具备**三重过滤机制**：

1. **中文区域过滤**（二、三、四）

   - 确保只在目标大区域内解析

2. **子区域检测**（问题反馈区域的 1、2 子标题）

   - 区分问题反馈和需求描述
   - 跳过子标题行

3. **序号格式过滤**
   - 带点序号（2.x, 3.x）：进度和计划
   - 纯数字序号：人员、机械、问题反馈

## 后续优化建议

1. **序号格式统一**

   - 建议 Excel 模板统一序号格式
   - 减少解析逻辑复杂度

2. **日志增强**

   - 记录跳过的子标题行
   - 记录解析到的问题数量

3. **配置化**

   - 将子标题标识（"问题描述"、"需求描述"）配置化
   - 支持不同的 Excel 模板变体

4. **异常检测**
   - 检测缺失的子标题
   - 检测序号格式异常
   - 给出友好的错误提示
