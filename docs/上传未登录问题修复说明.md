# ä¸Šä¼ æœªç™»å½•é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·å·²ç»ç™»å½•æˆåŠŸï¼Œä½†ç‚¹å‡»"å¼€å§‹ä¸Šä¼ "æŒ‰é’®æ—¶æç¤ºï¼š

```
æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•
```

## ğŸ” é—®é¢˜åŸå› 

### æ ¹æœ¬åŸå› 

`UploadService` ç±»åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ `AuthService()` å®ä¾‹ï¼Œè€Œè¿™ä¸ªæ–°å®ä¾‹æ²¡æœ‰ tokenã€‚

**é—®é¢˜ä»£ç **ï¼š

```python
class UploadService:
    def __init__(self):
        self.auth_service = AuthService()  # âŒ æ–°å®ä¾‹ï¼Œæ²¡æœ‰token

    def upload_daily_report_excel(self, ...):
        if not self.auth_service.is_logged_in():  # âŒ æ£€æŸ¥å¤±è´¥
            raise Exception('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•')
```

### é—®é¢˜åˆ†æ

- ä¸»çª—å£å’Œç™»å½•ç•Œé¢ä½¿ç”¨çš„æ˜¯å¦ä¸€ä¸ª `AuthService` å®ä¾‹ï¼ˆæœ‰ tokenï¼‰
- `UploadService` åˆ›å»ºçš„æ˜¯å…¨æ–°å®ä¾‹ï¼ˆæ—  tokenï¼‰
- ä¸¤ä¸ªå®ä¾‹äº’ä¸å…±äº«æ•°æ®
- å¯¼è‡´ç™»å½•çŠ¶æ€æ£€æŸ¥å¤±è´¥

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹æ€è·¯

å°† `UploadService` æ”¹ä¸ºæ¥å— `api_base_url` å’Œ `token` ä½œä¸ºå‚æ•°ï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°çš„ `AuthService` å®ä¾‹ã€‚

### ä¿®æ”¹å†…å®¹

#### 1. ä¿®æ”¹ `UploadService` ç±»

**ä¿®æ”¹å‰**ï¼š

```python
class UploadService:
    def __init__(self):
        self.auth_service = AuthService()
```

**ä¿®æ”¹å**ï¼š

```python
class UploadService:
    def __init__(self, api_base_url: str = None, token: str = None):
        """
        åˆå§‹åŒ–ä¸Šä¼ æœåŠ¡

        :param api_base_url: APIåŸºç¡€URL
        :param token: è®¤è¯Token
        """
        self.api_base_url = api_base_url
        self.token = token
```

#### 2. ä¿®æ”¹ç™»å½•çŠ¶æ€æ£€æŸ¥

**ä¿®æ”¹å‰**ï¼š

```python
if not self.auth_service.is_logged_in():
    raise Exception('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•')
```

**ä¿®æ”¹å**ï¼š

```python
if not self.token or not self.api_base_url:
    raise Exception('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•')
```

#### 3. ä¿®æ”¹ API è°ƒç”¨

**ä¿®æ”¹å‰**ï¼š

```python
api_base_url = self.auth_service.get_api_base_url()
token = self.auth_service.get_token()
headers = {'Authorization': f'Bearer {token}', ...}
```

**ä¿®æ”¹å**ï¼š

```python
headers = {'Authorization': f'Bearer {self.token}', ...}
import_url = f"{self.api_base_url}/api/v1/daily-reports/batch-import"
```

#### 4. ä¿®æ”¹ `UploadThread` ç±»

**ä¿®æ”¹å‰**ï¼š

```python
class UploadThread(QThread):
    def __init__(self, file_path: str, project_id: int, reporter_id: int):
        super().__init__()
        self.upload_service = UploadService()
```

**ä¿®æ”¹å**ï¼š

```python
class UploadThread(QThread):
    def __init__(self, file_path: str, project_id: int, reporter_id: int,
                 api_base_url: str, token: str):
        super().__init__()
        self.upload_service = UploadService(api_base_url, token)
```

#### 5. ä¿®æ”¹ä¸Šä¼ ç•Œé¢è°ƒç”¨

**ä¿®æ”¹å‰**ï¼š

```python
def start_upload(self):
    # ...
    self.upload_thread = UploadThread(file_path, project_id, reporter_id)
```

**ä¿®æ”¹å**ï¼š

```python
def start_upload(self):
    # è·å–è®¤è¯ä¿¡æ¯
    token = self.user_info.get('token') or self.config_service.get_token()
    api_base_url = self.config_service.get_login_info().get('server_url')

    if not token:
        QMessageBox.warning(self, "æç¤º", "ç™»å½•çŠ¶æ€å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•")
        return

    # åˆ›å»ºä¸Šä¼ çº¿ç¨‹æ—¶ä¼ å…¥è®¤è¯ä¿¡æ¯
    self.upload_thread = UploadThread(file_path, project_id, reporter_id,
                                     api_base_url, token)
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. `services/upload_service.py` - ä¿®æ”¹ `UploadService` ç±»
2. `ui/upload_widget.py` - ä¿®æ”¹ `UploadThread` å’Œ `start_upload` æ–¹æ³•

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
ç”¨æˆ·ç™»å½• âœ“
ç‚¹å‡»ä¸Šä¼  âœ— â†’ "æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•"
```

### ä¿®å¤å

```
ç”¨æˆ·ç™»å½• âœ“
ç‚¹å‡»ä¸Šä¼  âœ“ â†’ æ­£å¸¸ä¸Šä¼ 
```

## ğŸ”’ å®‰å…¨æ€§å¢å¼º

ä¿®å¤åçš„ä»£ç è¿˜å¢åŠ äº†ä»¥ä¸‹å®‰å…¨æ£€æŸ¥ï¼š

1. **Token æœ‰æ•ˆæ€§æ£€æŸ¥**ï¼š

   ```python
   if not token:
       QMessageBox.warning(self, "æç¤º", "ç™»å½•çŠ¶æ€å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•")
       return
   ```

2. **åŒé‡ Token è·å–**ï¼š

   ```python
   token = self.user_info.get('token') or self.config_service.get_token()
   ```

   - ä¼˜å…ˆä» `user_info` è·å–ï¼ˆå½“å‰ä¼šè¯ï¼‰
   - å¦‚æœæ²¡æœ‰åˆ™ä»é…ç½®æ–‡ä»¶è·å–ï¼ˆè‡ªåŠ¨ç™»å½•åœºæ™¯ï¼‰

3. **é¡¹ç›®ä¿¡æ¯éªŒè¯**ï¼š
   ```python
   if not self.project_info:
       QMessageBox.warning(self, "æç¤º", "æ²¡æœ‰é¡¹ç›®ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•")
       return
   ```

## ğŸ§ª æµ‹è¯•å»ºè®®

1. **æ­£å¸¸ç™»å½•ä¸Šä¼ æµ‹è¯•**

   - ä½¿ç”¨è´¦å·å¯†ç ç™»å½•
   - é€‰æ‹©æ–‡ä»¶å¹¶ç‚¹å‡»ä¸Šä¼ 
   - éªŒè¯ä¸Šä¼ æˆåŠŸ

2. **è‡ªåŠ¨ç™»å½•ä¸Šä¼ æµ‹è¯•**

   - å…³é—­åº”ç”¨
   - é‡æ–°æ‰“å¼€ï¼ˆè‡ªåŠ¨ç™»å½•ï¼‰
   - é€‰æ‹©æ–‡ä»¶å¹¶ç‚¹å‡»ä¸Šä¼ 
   - éªŒè¯ä¸Šä¼ æˆåŠŸ

3. **Token è¿‡æœŸæµ‹è¯•**
   - åˆ é™¤é…ç½®æ–‡ä»¶ä¸­çš„ token
   - ç‚¹å‡»ä¸Šä¼ 
   - éªŒè¯æç¤º"ç™»å½•çŠ¶æ€å·²å¤±æ•ˆ"

## ğŸ’¡ è®¾è®¡æ”¹è¿›

### åŸè®¾è®¡çš„é—®é¢˜

- ä½¿ç”¨å¤šä¸ª `AuthService` å®ä¾‹
- å®ä¾‹ä¹‹é—´ä¸å…±äº«çŠ¶æ€
- å®¹æ˜“å‡ºç°ç™»å½•çŠ¶æ€ä¸ä¸€è‡´

### æ”¹è¿›åçš„è®¾è®¡

- `UploadService` æ¥å—æ˜ç¡®çš„å‚æ•°
- ä¸ä¾èµ–å…¨å±€çŠ¶æ€æˆ–å•ä¾‹
- æ›´å®¹æ˜“æµ‹è¯•å’Œç»´æŠ¤
- ç¬¦åˆä¾èµ–æ³¨å…¥åŸåˆ™

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **ç»Ÿä¸€è®¤è¯ç®¡ç†**

   - è€ƒè™‘ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç† `AuthService`
   - æˆ–è€…ä½¿ç”¨ä¾èµ–æ³¨å…¥å®¹å™¨

2. **Token è‡ªåŠ¨åˆ·æ–°**

   - ä¸Šä¼ å‰æ£€æŸ¥ Token æ˜¯å¦å³å°†è¿‡æœŸ
   - è‡ªåŠ¨åˆ·æ–° Token

3. **é”™è¯¯æç¤ºä¼˜åŒ–**
   - åŒºåˆ†ä¸åŒçš„æœªç™»å½•åœºæ™¯
   - æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

---

**ä¿®å¤æ—¥æœŸ**: 2025-10-23
**å½±å“èŒƒå›´**: æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
**ä¼˜å…ˆçº§**: é«˜ ğŸ”´
**çŠ¶æ€**: å·²ä¿®å¤ âœ…
