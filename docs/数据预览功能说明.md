# 数据预览功能说明

## 📋 功能概述

在上传日报数据前，先解析 Excel 文件并在界面上展示解析结果，让用户确认数据无误后再执行上传。

## ✨ 新增功能

### 1. 数据预览表格

新增了一个数据预览面板，展示解析后的日报数据：

**显示字段**：

- 📅 日期 - 报表日期
- 📁 项目名称 - 所属项目
- 🎯 进度状态 - 正常/滞后/超前（带颜色标识）
- 📋 任务数 - 当天任务数量
- 👷 人员数 - 现场人员数量
- 🚜 机械数 - 租赁机械数量
- ⚠️ 问题数 - 反馈问题数量（有问题时标红）
- ☀️ 天气 - 当天天气情况

### 2. 预览按钮

添加了"🔍 预览数据"按钮：

- 添加文件后自动启用
- 点击后解析 Excel 文件
- 解析完成后展示在表格中

### 3. 颜色标识

**进度状态**：

- 🟢 正常 - 绿色
- 🔴 滞后 - 红色
- 🔵 超前 - 蓝色

**问题数**：

- 有问题时显示为红色加粗

## 🎯 使用流程

### 完整流程

```
1. 点击"➕ 添加文件"
   ↓
2. 选择日报Excel文件
   ↓
3. 点击"🔍 预览数据"
   ↓
4. 查看解析结果（表格展示）
   ↓
5. 确认数据无误
   ↓
6. 点击"开始上传"
   ↓
7. 确认上传对话框
   ↓
8. 上传完成
```

### 详细说明

#### 步骤 1：添加文件

```
点击"➕ 添加文件"按钮
→ 选择一个或多个Excel文件
→ 文件列表显示已添加的文件
→ "预览数据"按钮自动启用
→ "开始上传"按钮禁用（需先预览）
```

#### 步骤 2：预览数据

```
点击"🔍 预览数据"按钮
→ 按钮文字变为"解析中..."
→ 解析所有添加的Excel文件
→ 解析每个sheet工作表
→ 数据显示在表格中
→ 弹出提示："成功解析 X 条日报记录"
→ "开始上传"按钮启用
```

#### 步骤 3：确认并上传

```
检查表格中的数据
→ 确认日期、项目名称、人员数等信息
→ 点击"开始上传"
→ 弹出确认对话框："确定要上传 X 条日报记录吗？"
→ 点击"Yes"开始上传
→ 进度条显示上传进度
→ 上传完成后显示结果
```

## 📊 界面布局

```
┌─────────────────────────────────────────────────────────┐
│ 用户和项目信息                                          │
│ 用户: 徐经理 | 角色: 项目经理 | 当前项目: 测试项目      │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 添加文件                         [➕ 添加文件]          │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 📄 测试日报.xlsx                                        │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 数据预览                         [🔍 预览数据]          │
├─────────────────────────────────────────────────────────┤
│ 日期    │项目名称│进度状态│任务数│人员数│机械数│问题数│天气│
├─────────────────────────────────────────────────────────┤
│2025.10.19│测试项目│正常   │  5  │  12 │  3  │  1  │晴 │
│2025.10.20│测试项目│滞后   │  6  │  10 │  2  │  0  │阴 │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 上传进度                                                │
│ [████████████████████░░░░░░░░░░] 80%                    │
│ 正在上传...                                             │
└─────────────────────────────────────────────────────────┘

[清空列表]  [开始上传]
```

## 🔧 技术实现

### 1. 数据解析

**使用组件**：

- `DailyReportExcelParser` - Excel 解析器
- `convert_to_api_format` - 数据格式转换

**解析流程**：

```python
def preview_data(self):
    # 1. 解析所有文件
    for file_path in self.selected_files:
        parser = DailyReportExcelParser(file_path)
        all_reports = parser.parse_all_sheets()
        self.parsed_reports.extend(all_reports)

    # 2. 显示在表格中
    self.display_parsed_data()

    # 3. 启用上传按钮
    self.upload_button.setEnabled(True)
```

### 2. 表格展示

**表格配置**：

- 8 列固定宽度
- 自动拉伸最后一列
- 只读模式（不可编辑）
- 整行选择模式

**样式设置**：

```python
# 进度状态颜色
progress_colors = {
    'normal': QColor(76, 175, 80),    # 绿色
    'delayed': QColor(244, 67, 54),   # 红色
    'ahead': QColor(33, 150, 243)     # 蓝色
}

# 问题数标红
if problem_count > 0:
    problem_item.setForeground(QColor(244, 67, 54))
    problem_item.setFont(QFont("Arial", 10, QFont.Weight.Bold))
```

### 3. 上传优化

**改进前**：

```python
# 上传时重新解析Excel
def upload():
    parser = DailyReportExcelParser(file_path)
    reports = parser.parse_all_sheets()
    upload_data(reports)
```

**改进后**：

```python
# 使用预览时已解析的数据
def upload():
    if not self.parsed_reports:
        warning("请先预览数据")
        return
    upload_data(self.parsed_reports)
```

**优势**：

- ✅ 避免重复解析
- ✅ 确保上传的就是预览的数据
- ✅ 提高上传速度
- ✅ 减少错误风险

## 💡 用户体验优化

### 1. 按钮状态管理

**添加文件后**：

- ✅ 启用"预览数据"按钮
- ❌ 禁用"开始上传"按钮

**预览完成后**：

- ✅ 启用"开始上传"按钮
- ✅ 保持"预览数据"启用（可重新预览）

**上传过程中**：

- ❌ 禁用所有按钮
- 显示进度条和状态

**上传完成后**：

- ✅ 启用所有按钮
- 清空文件列表和表格

### 2. 提示信息

**状态提示**：

- "已添加 X 个文件，请点击"预览数据"查看"
- "正在解析 Excel 文件..."
- "解析完成，共 X 条日报记录"
- "正在上传..."
- "上传完成：成功 X 条，失败 X 条"

**对话框提示**：

- 解析成功："成功解析 X 条日报记录\n 请检查数据无误后点击"开始上传""
- 确认上传："确定要上传 X 条日报记录吗？"
- 上传结果："上传完成！\n 总计：X 条\n 成功：X 条\n 失败：X 条"

### 3. 错误处理

**解析错误**：

```python
try:
    parser = DailyReportExcelParser(file_path)
    reports = parser.parse_all_sheets()
except Exception as e:
    QMessageBox.warning(self, "解析错误", f"文件 {file_path} 解析失败：{str(e)}")
    continue  # 继续解析其他文件
```

**上传前验证**：

```python
if not self.parsed_reports:
    QMessageBox.warning(self, "提示", "请先点击"预览数据"查看解析结果")
    return
```

## 📝 数据字段说明

### 解析的数据结构

```json
{
  "reportDate": "2025.10.19",
  "projectName": "测试项目",
  "overallProgress": "normal",
  "progressDescription": "二期管道安装阶段",
  "taskProgressList": [
    {
      "taskNo": "2.1",
      "taskName": "管道安装",
      "plannedProgress": "80%",
      "actualProgress": "85%"
    }
  ],
  "workerReports": [
    {
      "name": "张三",
      "jobType": "电工",
      "workContent": "电缆安装"
    }
  ],
  "machineryRentals": [...],
  "problemFeedbacks": [...],
  "requirements": [...],
  "weather": "晴",
  "temperature": "25℃",
  "onSitePersonnelCount": 12,
  "remarks": null
}
```

### 表格显示的字段

| 字段     | 数据来源                | 说明                 |
| -------- | ----------------------- | -------------------- |
| 日期     | `reportDate`            | 报表日期             |
| 项目名称 | `projectName`           | 从 Excel 第一行解析  |
| 进度状态 | `overallProgress`       | normal/delayed/ahead |
| 任务数   | `len(taskProgressList)` | 任务列表长度         |
| 人员数   | `onSitePersonnelCount`  | 现场总人数           |
| 机械数   | `len(machineryRentals)` | 机械列表长度         |
| 问题数   | `len(problemFeedbacks)` | 问题列表长度         |
| 天气     | `weather`               | 天气情况             |

## 🎨 样式说明

### 表格样式

```css
QTableWidget {
  border: 2px solid #e0e0e0;
  border-radius: 5px;
  background-color: white;
  gridline-color: #e0e0e0;
}

QHeaderView::section {
  background-color: #f0f0f0;
  color: #000000;
  padding: 8px;
  font-weight: bold;
}
```

### 按钮样式

```css
预览按钮: #2196F3 (蓝色)
上传按钮: #4CAF50 (绿色)
清空按钮: #9E9E9E (灰色)
```

## 🔍 测试建议

### 功能测试

1. **单文件测试**

   - 添加 1 个 Excel 文件
   - 预览数据
   - 验证表格显示正确

2. **多文件测试**

   - 添加多个 Excel 文件
   - 预览数据
   - 验证合并显示所有数据

3. **多 Sheet 测试**

   - 添加包含多个 sheet 的 Excel
   - 预览数据
   - 验证解析所有 sheet

4. **错误文件测试**
   - 添加格式错误的 Excel
   - 预览数据
   - 验证错误提示

### 交互测试

1. **按钮状态测试**

   - 验证添加文件后按钮状态
   - 验证预览后按钮状态
   - 验证上传中按钮状态
   - 验证上传后按钮状态

2. **数据一致性测试**

   - 预览的数据
   - 上传的数据
   - 验证两者完全一致

3. **清空功能测试**
   - 预览后清空
   - 验证表格被清空
   - 验证按钮恢复初始状态

## 🚀 后续优化建议

### 1. 数据编辑功能

- 支持在表格中修改数据
- 支持删除某条记录
- 支持添加新记录

### 2. 数据导出功能

- 导出为 CSV 格式
- 导出为 Excel 格式
- 导出为 PDF 格式

### 3. 详情查看功能

- 双击行查看完整详情
- 显示所有任务列表
- 显示所有人员列表
- 显示所有问题反馈

### 4. 数据统计功能

- 显示总计信息
- 显示平均值
- 显示异常数据

### 5. 筛选和排序

- 按日期筛选
- 按进度状态筛选
- 按问题数排序

---

**实现日期**: 2025-10-23
**版本**: v2.1
**状态**: ✅ 已完成
