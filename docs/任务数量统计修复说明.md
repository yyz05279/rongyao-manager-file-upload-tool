# 任务数量统计修复说明

## 问题描述

数据预览表格中显示的任务数量与 Excel 中的实际任务数量不一致。

## 原因分析

### Python 版本（正确实现）

- 任务数量统计：`len(report.get('taskProgressList', []))`
- 只统计序号以"2."开头的任务行
- 通过`_parse_task_progress`方法解析第 6-20 行，过滤出序号为"2.1"、"2.2"、"2.3"等的任务

### Rust 版本（错误实现）

- 任务数量统计：`total_rows`（总行数-1）
- 没有按照规则过滤任务
- 缺少完整的解析逻辑

## 修复方案

### 1. 重写 Rust Excel 解析器 (`tauri-app/src-tauri/src/excel.rs`)

#### 主要改动

- **完整实现 Python 版本的解析逻辑**
- 添加了 6 个专门的解析函数：
  - `parse_task_progress()` - 解析逐项进度汇报（序号 2.x）
  - `parse_tomorrow_plans()` - 解析明天工作计划（序号 3.x）
  - `parse_worker_reports()` - 解析各工种工作汇报（区域二）
  - `parse_machinery_rentals()` - 解析机械租赁情况（区域三）
  - `parse_problem_feedbacks()` - 解析问题反馈（区域四，序号 1.x 或纯数字）
  - `parse_requirements()` - 解析需求描述（区域四，子区域 2）

#### 返回数据结构

```json
{
  "reportDate": "2025.10.1",
  "reporterName": "淮安",
  "overallProgress": "normal",
  "progressDescription": "二期项目初始阶段",
  "taskProgressList": [...],      // 任务数组
  "tomorrowPlans": [...],         // 计划数组
  "workerReports": [...],         // 工作人员数组
  "machineryRentals": [...],      // 机械数组
  "problemFeedbacks": [...],      // 问题数组
  "requirements": [...],          // 需求数组
  "onSitePersonnelCount": 0,      // 现场总人数
  "weather": null,
  "temperature": null,
  "remarks": null
}
```

### 2. 更新前端 DataPreview 组件 (`tauri-app/src/components/DataPreview.jsx`)

#### 修改前

```jsx
<td>{report.taskCount || 0}</td>
<td>{report.onSitePersonnelCount || 0}</td>
<td>{report.machineryCount || 0}</td>
<td className={report.problemCount > 0 ? "has-problems" : ""}>
  {report.problemCount || 0}
</td>
```

#### 修改后

```jsx
<td>{report.taskProgressList?.length || 0}</td>
<td>{report.onSitePersonnelCount || 0}</td>
<td>{report.machineryRentals?.length || 0}</td>
<td className={(report.problemFeedbacks?.length || 0) > 0 ? "has-problems" : ""}>
  {report.problemFeedbacks?.length || 0}
</td>
```

#### 改动说明

- **任务数**：从`taskCount`改为`taskProgressList?.length`
- **机械数**：从`machineryCount`改为`machineryRentals?.length`
- **问题数**：从`problemCount`改为`problemFeedbacks?.length`

## 测试验证

### 测试数据（assets/淮安日报 2025.10.19.xlsx）

使用 Python 解析器验证：

```bash
python3 parse_daily_report_excel.py "assets/淮安日报2025.10.19.xlsx"
```

预期结果：

- 2025.10.1: 任务数量: 3
- 2025.10.2: 任务数量: 4
- 2025.10.3: 任务数量: 3
- 2025.10.4: 任务数量: 4
- 2025.10.5: 任务数量: 2
- ...

### 测试步骤

1. 启动 Tauri 应用：`npm run tauri dev`
2. 登录系统
3. 选择 Excel 文件（assets/淮安日报 2025.10.19.xlsx）
4. 查看数据预览表格
5. 对比任务数量是否与 Python 解析结果一致

## 版本对比

| 项目         | Python 版本 | Rust 版本（修复前） | Rust 版本（修复后） |
| ------------ | ----------- | ------------------- | ------------------- |
| 任务数统计   | ✅ 序号 2.x | ❌ 总行数           | ✅ 序号 2.x         |
| 完整数据结构 | ✅          | ❌ 简化版           | ✅                  |
| 区域解析     | ✅          | ❌                  | ✅                  |
| 数据准确性   | ✅          | ❌                  | ✅                  |

## 修改文件清单

1. `tauri-app/src-tauri/src/excel.rs` - 完全重写 Excel 解析逻辑
2. `tauri-app/src/components/DataPreview.jsx` - 修改统计字段显示

## 总结

通过重写 Rust 版本的 Excel 解析器，使其完全遵循 Python 版本的解析规则，确保了：

1. ✅ 任务数量统计准确（只统计序号 2.x 的任务）
2. ✅ 机械数量统计准确（只统计区域三的机械）
3. ✅ 问题数量统计准确（只统计区域四的问题）
4. ✅ 数据结构与 Python 版本完全一致
5. ✅ 支持区域化解析（一、二、三、四等区域）

修复后的 Tauri 应用将与 Python 版本保持完全一致的数据解析结果。
