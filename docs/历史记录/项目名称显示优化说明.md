# 项目名称显示优化说明

## 需求

1. 用户登录后，调用 `my-project` 接口获取当前项目信息
2. 在用户信息那一行展示项目名称
3. 在 Excel 数据预览的项目名称列展示接口返回的项目名称（而不是 Excel 中解析的名称）

## 实现方案

### 1. 在用户信息行显示项目名称

**文件**：`tauri-app/src/components/UploadForm.jsx`

参考 Python 代码中的实现：

```python
# Python 代码（ui/upload_widget.py）
# 使用水平布局，将用户信息和项目信息放在同一行
layout = QHBoxLayout(panel)

# 用户信息
self.user_label = QLabel("未登录")
layout.addWidget(self.user_label)

# 当前项目标签
project_label = QLabel("当前项目:")
layout.addWidget(project_label)

# 项目名称
self.project_name_value = QLabel("未加载")
self.project_name_value.setStyleSheet("color: #2196F3; font-size: 14px; font-weight: bold;")
layout.addWidget(self.project_name_value)
```

**Tauri 实现**：

```jsx
<div className="user-info">
  <span>
    👤 {userInfo?.name || userInfo?.username}
    {userInfo?.role && ` (${getRoleText(userInfo.role)})`}
    {projectInfo && (
      <span style={{ marginLeft: "20px" }}>
        | 当前项目:{" "}
        <strong style={{ color: "#FFD700" }}>{projectInfo.name}</strong>
      </span>
    )}
  </span>
  <button className="btn-logout" onClick={logout}>
    退出
  </button>
</div>
```

**显示效果**：

```
📤 文件上传              👤 徐经理 (项目经理) | 当前项目: 淮安熔盐储能项目    [退出]
```

### 2. 数据预览使用实际项目名称

**问题**：Excel 解析时，项目名称是从 Excel 文件中提取的（通常不准确或为空），需要替换为接口返回的实际项目名称。

**解决方案**：

```javascript
const parseExcelFile = async (path) => {
  setParsing(true);
  setMessage("⏳ 正在解析 Excel 文件...");
  setParsedReports([]);
  setSelectedReports([]);

  try {
    const result = await excelAPI.parseExcel(path);
    if (result && result.reports) {
      // ✅ 用实际的项目名称替换 Excel 中解析的项目名称（参考 Python 代码）
      const reportsWithProjectName = result.reports.map((report) => ({
        ...report,
        reporterName: projectInfo?.name || report.reporterName,
      }));

      setParsedReports(reportsWithProjectName);
      setMessage(`✅ 解析成功！找到 ${result.reports.length} 条日报`);
    } else {
      setMessage("⚠️ 未找到日报数据");
    }
  } catch (err) {
    setMessage(`❌ 解析失败: ${err.message || err}`);
    console.error("Excel 解析错误:", err);
  } finally {
    setParsing(false);
  }
};
```

**关键点**：

- 使用 `map` 遍历解析后的报表
- 用 `projectInfo?.name` 替换 `report.reporterName`
- 如果没有项目信息，使用原始解析的名称作为 fallback

### 3. 样式优化

**文件**：`tauri-app/src/App.css`

```css
.user-info {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap; /* ✅ 响应式换行 */
}

.user-info span {
  display: flex;
  align-items: center;
  gap: 8px; /* ✅ 子元素间距 */
}
```

## 效果对比

### 修改前

**顶部显示**：

```
📤 文件上传              👤 徐经理 (项目经理)    [退出]
```

**数据预览**：

```
┌─────────────────────────────────────┐
│ ✓  日期    项目名称  进度  任务...   │
├─────────────────────────────────────┤
│ ☐  10.1   未知项目   正常   40      │  ← Excel 解析的名称
│ ☐  10.2   未知项目   正常   40      │
│ ☐  10.3   未知项目   正常   40      │
└─────────────────────────────────────┘
```

### 修改后

**顶部显示**：

```
📤 文件上传              👤 徐经理 (项目经理) | 当前项目: 淮安熔盐储能项目    [退出]
                                               ↑ 金色高亮显示
```

**数据预览**：

```
┌─────────────────────────────────────┐
│ ✓  日期    项目名称          进度... │
├─────────────────────────────────────┤
│ ☐  10.1   淮安熔盐储能项目  正常     │  ← 接口返回的项目名称
│ ☐  10.2   淮安熔盐储能项目  正常     │
│ ☐  10.3   淮安熔盐储能项目  正常     │
└─────────────────────────────────────┘
```

## 数据流程

```
1. 用户登录
   ↓
2. authStore 调用 getProject()
   ↓
3. 获取 projectInfo（包含项目名称等）
   ↓
4. 顶部显示：👤 徐经理 (项目经理) | 当前项目: 淮安熔盐储能项目
   ↓
5. 用户选择 Excel 文件
   ↓
6. 解析 Excel 文件
   ↓
7. 用 projectInfo.name 替换解析出的项目名称
   ↓
8. 数据预览表格显示：淮安熔盐储能项目
```

## Python 对照

### Python 实现（ui/upload_widget.py）

```python
def set_user_info(self, user_info: dict, project_info: dict = None):
    """设置用户信息和项目信息"""
    self.user_info = user_info
    self.project_info = project_info

    # 显示用户信息：姓名 + 手机号
    name = user_info.get('name', '未知用户')
    phone = user_info.get('phone') or user_info.get('username', '')

    if phone:
        display_text = f"{name} {phone}"
    else:
        display_text = name

    self.user_label.setText(display_text)

    # 显示项目信息
    if project_info:
        # 只显示项目名称
        project_name = project_info.get('name', '未知项目')
        self.project_name_value.setText(project_name)  # ← 显示在用户信息同一行
```

### Tauri 实现

```jsx
const { token, userInfo, projectInfo, logout, getProject } = useAuthStore();

// 顶部显示
<span>
  👤 {userInfo?.name || userInfo?.username}
  {userInfo?.role && ` (${getRoleText(userInfo.role)})`}
  {projectInfo && (
    <span>
      | 当前项目: <strong>{projectInfo.name}</strong>
    </span>
  )}
</span>;
```

## 项目信息结构

从接口 `/api/v1/projects/my-project` 返回的数据结构：

```json
{
  "code": 1,
  "data": {
    "id": 1,
    "name": "淮安熔盐储能项目",
    "type": "binary_salt",
    "typeDisplayName": "二元化盐项目",
    "status": "in_progress",
    "statusDisplayName": "进行中",
    "manager": "徐经理",
    "managerId": 10,
    "contactPhone": "13959141232",
    "estimatedSaltAmount": 50.0,
    "actualSaltAmount": 550.0,
    "completionProgress": 999.99,
    "createdAt": "2024-10-15T08:30:00Z",
    "updatedAt": "2024-10-23T10:51:07Z"
  }
}
```

## 测试步骤

1. **登录应用**

   - 使用测试账号登录
   - 确认自动获取项目信息

2. **查看顶部显示**

   - 确认显示：`👤 徐经理 (项目经理) | 当前项目: 淮安熔盐储能项目`
   - 项目名称应为金色高亮

3. **选择 Excel 文件**

   - 选择测试文件：`assets/淮安日报2025.10.19.xlsx`
   - 等待解析完成

4. **查看数据预览**

   - 确认"项目名称"列全部显示：`淮安熔盐储能项目`
   - 而不是 Excel 中的"未知项目"或其他名称

5. **验证一致性**
   - 顶部显示的项目名称 = 预览表格中的项目名称
   - 都来自接口返回的 `projectInfo.name`

## 优势

1. **数据一致性**：所有地方显示的项目名称都来自接口，确保准确
2. **用户体验**：一目了然地看到当前操作的项目
3. **参考 Python**：与 Python 应用保持一致的交互逻辑
4. **容错处理**：如果项目信息未加载，使用 Excel 解析的名称作为 fallback

## 相关文件

- `tauri-app/src/components/UploadForm.jsx` - 主要实现
- `tauri-app/src/App.css` - 样式优化
- `tauri-app/src/stores/authStore.js` - 状态管理
- `ui/upload_widget.py` - Python 参考实现

## 注意事项

1. **项目信息加载时机**：确保在选择文件前已获取项目信息
2. **空值处理**：使用可选链 `projectInfo?.name` 避免错误
3. **颜色对比**：金色 `#FFD700` 在紫色背景上对比度好，易识别
4. **响应式**：使用 `flex-wrap: wrap` 确保小屏幕上正常显示

✅ **优化完成！项目名称显示更加清晰和一致。**
