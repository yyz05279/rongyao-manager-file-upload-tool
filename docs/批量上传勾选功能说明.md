# 批量上传勾选功能说明

## 修改日期

2025 年 10 月 23 日

## 功能概述

为批量上传功能添加了**勾选选择**机制，用户可以：

- ✅ 对每个日期的日报进行勾选
- ✅ 只上传勾选的日报记录
- ✅ 在上传按钮上看到勾选数量统计

## 核心功能

### 1. 数据表格勾选列

**表格布局**：

```
[✓] 日期 | 项目名称 | 进度状态 | 任务数 | 人员数 | 机械数 | 问题数 | 天气
[□] 2025.10.1 | ...
[□] 2025.10.2 | ...
[☑] 2025.10.3 | ...  ← 已勾选
```

**特点**：

- 第一列为勾选框，默认全部不勾选
- 支持逐个勾选单条日报
- 实时更新上传按钮文本

### 2. 上传按钮动态统计

**按钮文本示例**：

```
开始上传           ← 未勾选任何项
开始上传 (1/5)     ← 勾选 1 条，共 5 条
开始上传 (3/5)     ← 勾选 3 条，共 5 条
```

**功能**：

- 未勾选时，按钮禁用，显示 "开始上传"
- 勾选后，按钮启用，显示 "开始上传 (x/y)"
- 实时更新勾选计数

### 3. 选择性上传

**流程**：

```
1. 预览数据后，表格显示所有日报记录
   ↓
2. 用户勾选要上传的日报
   ↓
3. 点击 "开始上传 (x/y)" 按钮
   ↓
4. 确认对话框显示选中的数量
   ↓
5. 只上传勾选的日报
```

## 实现细节

### 文件修改

**文件**：`ui/upload_widget.py`

#### 1. 初始化勾选状态存储

```python
def __init__(self):
    # ... 其他初始化 ...
    self.checked_reports = set()  # ✅ 存储勾选的日报索引
```

#### 2. 表格结构变更

**修改前**：

```python
self.data_table.setColumnCount(8)
self.data_table.setHorizontalHeaderLabels([
    "日期", "项目名称", "进度状态", "任务数", "人员数",
    "机械数", "问题数", "天气"
])
```

**修改后**：

```python
self.data_table.setColumnCount(9)  # ✅ 增加勾选列
self.data_table.setHorizontalHeaderLabels([
    "✓", "日期", "项目名称", "进度状态", "任务数", "人员数",
    "机械数", "问题数", "天气"
])
```

#### 3. 勾选框添加

```python
def display_parsed_data(self):
    for row, report in enumerate(self.parsed_reports):
        # ✅ 新增：勾选框列
        check_box = QTableWidgetItem()
        check_box.setFlags(Qt.ItemFlag.ItemIsUserCheckable | Qt.ItemFlag.ItemIsEnabled)
        check_box.setCheckState(Qt.CheckState.Unchecked)
        self.data_table.setItem(row, 0, check_box)

        # 其他列的索引向后移一位
        self.data_table.setItem(row, 1, date_item)    # 原来是 0
        self.data_table.setItem(row, 2, reporter_item) # 原来是 1
        # ...
```

#### 4. 按钮文本更新

```python
def update_upload_button_text(self):
    """更新上传按钮文本，显示勾选数量"""
    checked_count = 0
    for row in range(self.data_table.rowCount()):
        item = self.data_table.item(row, 0)
        if item and item.checkState() == Qt.CheckState.Checked:
            checked_count += 1

    total_count = len(self.parsed_reports)
    if checked_count == 0:
        self.upload_button.setText("开始上传")
        self.upload_button.setEnabled(False)
    else:
        self.upload_button.setText(f"开始上传 ({checked_count}/{total_count})")
        self.upload_button.setEnabled(True)
```

**触发时机**：

- 显示数据后自动调用一次
- 勾选框状态变化时自动调用（通过 `itemChanged` 信号）

#### 5. 上传逻辑修改

```python
def start_upload(self):
    """开始上传"""
    # ✅ 新增：收集勾选的日报
    checked_reports = []
    for row in range(self.data_table.rowCount()):
        item = self.data_table.item(row, 0)
        if item and item.checkState() == Qt.CheckState.Checked:
            checked_reports.append(self.parsed_reports[row])

    # ✅ 检查是否有勾选
    if not checked_reports:
        QMessageBox.warning(self, "提示", "请勾选要上传的日报")
        return

    # ... 认证信息 ...

    # ✅ 修改：确认信息显示勾选数量
    msg_box.setText(f"确定要上传选中的 {len(checked_reports)} 条日报记录吗？")

    # ✅ 修改：只上传勾选的日报
    self.upload_thread = UploadThread(
        checked_reports,  # 只上传勾选的
        project_id,
        reporter_id,
        # ...
    )
```

#### 6. 清空列表时重置

```python
def clear_file_list(self):
    if reply == QMessageBox.StandardButton.Yes:
        self.selected_files.clear()
        self.parsed_reports.clear()
        self.checked_reports.clear()  # ✅ 清除勾选状态
        self.file_list.clear()
        self.data_table.setRowCount(0)
        self.progress_bar.setValue(0)
        self.status_label.setText("已清空文件列表")
        self.preview_button.setEnabled(False)
        self.upload_button.setEnabled(False)
        self.upload_button.setText("开始上传")  # ✅ 重置按钮文本
```

## 用户操作流程

### 场景 1：全选上传

```
1. 选择 Excel 文件
   ↓
2. 点击 "预览数据"
   ↓
3. 表格显示 5 条日报记录
   ↓
4. 逐个点击勾选框 ✓
   ↓
5. 上传按钮显示 "开始上传 (5/5)"
   ↓
6. 点击上传按钮
   ↓
7. 确认对话框："确定要上传选中的 5 条日报记录吗？"
   ↓
8. 点击"确定"开始上传
```

### 场景 2：选择性上传

```
1. 预览数据后显示 5 条日报
   ↓
2. 只勾选需要上传的 3 条
   ↓
3. 上传按钮显示 "开始上传 (3/5)"
   ↓
4. 点击上传
   ↓
5. 只有 3 条日报被上传到服务器
```

## 特性亮点

### ✅ 灵活选择

- 支持选择性上传，不必上传全部记录
- 适合有多个日期但只想上传部分的场景

### ✅ 实时反馈

- 勾选状态即时更新按钮文本
- 用户清晰了解选择了多少条

### ✅ 安全确认

- 上传前再次确认选中数量
- 防止意外上传错误的日报

### ✅ 直观易用

- 勾选框位置明显（第一列）
- 按钮文本清晰展示选择统计

## 数据表结构变更

### 列索引映射

| 原索引 | 原列名   | 新索引 | 新列名     |
| ------ | -------- | ------ | ---------- |
| -      | -        | 0      | ✓ (勾选框) |
| 0      | 日期     | 1      | 日期       |
| 1      | 项目名称 | 2      | 项目名称   |
| 2      | 进度状态 | 3      | 进度状态   |
| 3      | 任务数   | 4      | 任务数     |
| 4      | 人员数   | 5      | 人员数     |
| 5      | 机械数   | 6      | 机械数     |
| 6      | 问题数   | 7      | 问题数     |
| 7      | 天气     | 8      | 天气       |

## 处理流程

### 数据预览后

```
display_parsed_data()
    ↓
创建表格行，每行添加勾选框
    ↓
监听 itemChanged 信号
    ↓
调用 update_upload_button_text()
    ↓
按钮文本显示 "开始上传"，按钮禁用
```

### 用户勾选后

```
用户点击勾选框
    ↓
itemChanged 信号触发
    ↓
update_upload_button_text() 自动调用
    ↓
计算勾选数量
    ↓
按钮文本更新为 "开始上传 (x/y)"，按钮启用
```

### 点击上传后

```
start_upload() 被调用
    ↓
遍历表格，收集勾选的日报
    ↓
验证选择不为空
    ↓
显示确认对话框
    ↓
用户确认后
    ↓
创建 UploadThread，传递 checked_reports
    ↓
后台线程上传
```

## 测试建议

### 测试场景 1：全选

1. 预览数据显示 5 条
2. 全部勾选
3. 按钮显示 "开始上传 (5/5)"
4. 上传成功

### 测试场景 2：部分选择

1. 预览数据显示 5 条
2. 只勾选 2 条
3. 按钮显示 "开始上传 (2/5)"
4. 上传成功，只有 2 条被上传

### 测试场景 3：未勾选

1. 预览数据显示 5 条
2. 不勾选任何项
3. 按钮显示 "开始上传"，禁用
4. 尝试点击时无反应或显示提示

### 测试场景 4：清空列表

1. 预览数据、勾选部分项
2. 点击"清空列表"
3. 验证勾选状态被清除
4. 验证按钮文本重置为 "开始上传"

## 注意事项

### ⚠️ 重要

- 勾选框位于第 0 列，其他列索引全部后移
- 勾选状态通过 `itemChanged` 信号实时更新
- 未勾选任何项时，上传按钮禁用

### 💡 设计考虑

- 勾选框默认全部未选，提高安全性
- 按钮文本实时更新，用户体验好
- 确认对话框再次显示选择数量，防止误操作

## 后续优化建议

1. **全选/反选按钮**

   - 在表格上方添加 "全选" / "反选" 按钮
   - 快速选择大量日报

2. **按日期范围选择**

   - 添加日期范围选择器
   - 快速选择某段时间的日报

3. **勾选状态记忆**

   - 保存勾选状态到配置
   - 下次预览时恢复选择

4. **批量操作**
   - 支持删除选中的预览数据
   - 支持预览选中的详细信息

## 修改文件

- ✅ `ui/upload_widget.py`：实现勾选功能和选择性上传

## 相关文档

- 数据预览功能说明.md
- 批量上传 API 说明.md
