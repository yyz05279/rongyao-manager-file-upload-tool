# API 调试输出说明

## 功能概述

在日报上传过程中，添加了**完整的 API 请求和响应数据输出**，方便调试和查看后台返回的详细信息。

## 输出内容

### 1. 上传请求体

**输出时机**：发送请求到服务器之前

**输出格式**：
```
================================================================================
📤 发送上传请求 - API请求体
================================================================================
{
  "projectId": 9,
  "reporterId": 10,
  "overwriteExisting": false,
  "reports": [
    {
      "reportDate": "2025-10-21",
      "reporterName": "徐经理",
      "overallProgress": "normal",
      "progressDescription": "管道安装阶段",
      "taskProgressList": "[{\"taskNo\":\"2.1\",\"taskName\":\"电伴热电源接线\"}]",
      ...
    }
  ]
}
================================================================================
```

**用途**：
- ✅ 验证发送给服务器的数据格式是否正确
- ✅ 检查字段名称和值是否符合API要求
- ✅ 确认序号和标题过滤是否生效

### 2. 服务器响应数据

**输出时机**：收到服务器响应后

**输出格式**（成功）：
```
================================================================================
📥 收到服务器响应 - 原始响应数据
================================================================================
{
  "code": 1,
  "msg": "查询成功",
  "data": {
    "total": 1,
    "totalPages": 1,
    "page": 1,
    "size": 10,
    "records": [
      {
        "id": 25,
        "projectId": 9,
        "projectName": "小目标测试项目",
        "reportDate": "2025-10-21",
        "reporterId": 10,
        "reporterName": "徐经理",
        "overallProgress": "normal",
        "overallProgressDisplayName": "正常",
        "progressDescription": "管道安装阶段",
        ...
      }
    ]
  }
}
================================================================================
```

**输出格式**（失败）：
```
================================================================================
❌ 上传失败 - 错误信息
================================================================================
项目不存在
================================================================================
```

**用途**：
- ✅ 查看后台返回的完整数据结构
- ✅ 验证上传是否成功以及具体的失败原因
- ✅ 调试和排查数据问题

### 3. 上传完成统计

**输出时机**：上传完成后在 UI 弹框中显示

**显示内容**：
```
上传完成！

总计：3 条
成功：2 条
失败：1 条

失败详情：
- 日期: 2025-10-15
  原因: 该项目在此日期已存在日报
```

**用途**：
- ✅ 快速查看上传结果统计
- ✅ 了解失败的具体原因

### 4. 异常错误堆栈

**输出时机**：上传过程中发生异常

**输出格式**：
```
================================================================================
❌ 上传错误 - 异常堆栈
================================================================================
Traceback (most recent call last):
  File "ui/upload_widget.py", line 74, in run
    data = base_service.parse_response(response, expected_code=1)
  File "services/base_service.py", line 45, in parse_response
    raise Exception(f"API返回错误: {error_msg}")
Exception: API返回错误: 网络连接失败
================================================================================
```

**用途**：
- ✅ 快速定位错误发生的位置和原因
- ✅ 便于问题排查和修复

## 控制台输出示例

### 成功上传示例

```
================================================================================
📤 发送上传请求 - API请求体
================================================================================
{
  "projectId": 9,
  "reporterId": 10,
  "overwriteExisting": false,
  "reports": [...]
}
================================================================================

================================================================================
📥 收到服务器响应 - 原始响应数据
================================================================================
{
  "code": 1,
  "msg": "查询成功",
  "data": {...}
}
================================================================================

================================================================================
✅ 上传成功 - 完整的后台响应数据
================================================================================
{
  "totalCount": 1,
  "successCount": 1,
  "failedCount": 0,
  "skippedCount": 0,
  "successReports": [{"reportDate": "2025-10-21", "projectName": "小目标测试项目"}],
  "failedReports": []
}
================================================================================
```

## 修改文件

### 文件：ui/upload_widget.py

#### 1. UploadThread.run() 方法

**新增**：
- 发送请求前输出完整的 API 请求体
- 收到响应后输出原始响应数据
- 异常时输出详细的错误堆栈

#### 2. UploadWidget.on_upload_success() 方法

**新增**：
- 输出完整的后台响应数据到控制台
- 在 UI 弹框中显示失败记录的详细原因

#### 3. UploadWidget.on_upload_failed() 方法

**新增**：
- 输出错误信息到控制台

## 使用方法

### 查看控制台输出

1. **启动应用**
   ```bash
   python3 main.py
   ```

2. **执行上传操作**
   - 选择 Excel 文件
   - 点击"开始上传"按钮

3. **查看输出**
   - 在启动应用的终端窗口中查看详细输出
   - 或者在 IDE 的控制台中查看

### 调试技巧

1. **验证数据格式**
   - 查看"📤 发送上传请求"部分
   - 检查字段名称、数据类型是否正确
   - 确认 JSON 字符串格式是否合法

2. **排查上传失败**
   - 查看"📥 收到服务器响应"部分
   - 检查错误代码和错误信息
   - 查看失败记录的原因字段

3. **调查异常问题**
   - 查看"❌ 上传错误 - 异常堆栈"部分
   - 根据堆栈跟踪定位问题位置
   - 检查网络连接、认证信息等

## 隐私注意事项

⚠️ **注意**：控制台输出包含以下敏感信息，请在生产环境中谨慎处理：
- 完整的请求体（包括所有日报数据）
- 服务器响应数据（包括用户信息和项目数据）
- 认证令牌（由 HTTP 请求头中传递）

## 后续改进建议

1. 可添加日志文件支持，将输出保存到文件
2. 可添加日志级别控制（DEBUG/INFO/WARNING/ERROR）
3. 可添加敏感信息脱敏功能（隐藏 token 等）
4. 可添加输出格式选择（文本/JSON/CSV）

---

**修改日期**：2025-10-23  
**涉及文件**：`ui/upload_widget.py`
