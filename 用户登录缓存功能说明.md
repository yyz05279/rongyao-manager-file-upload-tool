# 用户登录缓存功能说明

## 修改日期

2025 年 10 月 23 日

## 功能概述

用户登录后，系统会自动保存用户信息到本地缓存。下次启动应用时，如果缓存中存在有效的用户信息和Token，可以直接使用缓存数据，无需重新登录。

## 核心特性

- ✅ **自动缓存用户信息**：登录成功后自动保存用户数据
- ✅ **快速自动登录**：应用启动时自动加载缓存信息
- ✅ **本地持久化存储**：用户数据存储在用户主目录下 `.molten_salt_uploader` 目录
- ✅ **缓存更新同步**：Token刷新时自动更新缓存
- ✅ **安全清除**：登出时完全清除用户信息缓存

## 技术实现

### 1. 缓存存储结构

**配置文件位置**：`~/.molten_salt_uploader/config.json`

**缓存数据结构**：
```json
{
  "server_url": "http://42.192.76.234:8081",
  "username": "用户名或手机号",
  "token": "JWT访问Token",
  "refresh_token": "刷新Token",
  "expires_at": "Token过期时间",
  "user_info": {
    "id": 用户ID,
    "username": "用户名",
    "name": "用户姓名",
    "email": "邮箱",
    "role": "用户角色"
  }
}
```

### 2. 修改的文件

#### 文件 1：`services/config_service.py`

**新增方法**：

```python
def save_user_info(self, user_info: Dict):
    """
    保存用户信息到本地缓存
    
    :param user_info: 用户信息字典，包含id、username、name、email、role等
    """
    # 保存用户基本信息
    self._config['user_info'] = {
        'id': user_info.get('id'),
        'username': user_info.get('username'),
        'name': user_info.get('name'),
        'email': user_info.get('email'),
        'role': user_info.get('role'),
    }
    
    # 同时保存Token相关信息
    if user_info.get('token'):
        self._config['token'] = user_info.get('token')
    if user_info.get('refreshToken'):
        self._config['refresh_token'] = user_info.get('refreshToken')
    if user_info.get('expiresAt'):
        self._config['expires_at'] = user_info.get('expiresAt')
    
    self._save_config()

def get_user_info(self) -> Optional[Dict]:
    """
    获取缓存的用户信息
    
    :return: 用户信息字典或None
    """
    user_info = self._config.get('user_info')
    if user_info:
        # 添加Token信息到用户信息中
        user_info['token'] = self._config.get('token')
        user_info['refreshToken'] = self._config.get('refresh_token')
        user_info['expiresAt'] = self._config.get('expires_at')
    return user_info

def clear_user_info(self):
    """清除缓存的用户信息"""
    self._config.pop('user_info', None)
    self._save_config()
```

#### 文件 2：`ui/login_widget.py`

**修改位置**：`on_login_success` 方法

**修改内容**：
```python
def on_login_success(self, user_info: dict):
    """登录成功处理"""
    # ... 现有代码 ...
    
    # ✅ 新增：保存用户信息到本地缓存
    self.config_service.save_user_info(user_info)
    print("✅ 用户信息已缓存到本地")
    
    self.login_success.emit(user_info)
```

#### 文件 3：`ui/main_window.py`

**修改位置**：`try_auto_login` 方法

**修改内容**：
```python
def try_auto_login(self):
    """尝试自动登录（使用保存的Token）"""
    # ... 现有代码 ...
    
    # ✅ 首先尝试从本地缓存获取用户信息
    cached_user_info = self.config_service.get_user_info()
    if cached_user_info:
        print("✅ 从本地缓存获取用户信息")
        print(f"缓存用户ID: {cached_user_info.get('id')}")
        print(f"缓存用户名: {cached_user_info.get('username')}")
    
    # ... 其他代码 ...
    
    # ✅ Token有效，使用缓存的用户信息或构建新的用户信息
    if cached_user_info:
        # 优先使用本地缓存的完整用户信息
        self.user_info = cached_user_info
        print("✅ 使用缓存的用户信息\n")
    else:
        # 如果没有缓存，使用简化版用户信息
        # ...
```

**修改位置**：`on_logout` 方法

**修改内容**：
```python
def on_logout(self):
    """退出登录处理"""
    # ... 现有代码 ...
    
    self.config_service.clear_user_info()  # ✅ 清除缓存的用户信息
    
    # ... 其他代码 ...
```

## 工作流程

### 登录流程

```
1. 用户输入用户名、密码、服务器地址
        ↓
2. 发送登录请求到服务器
        ↓
3. 服务器返回用户信息 + Token
        ↓
4. ✅ 自动保存：
   - 用户基本信息到 user_info
   - Token到 token
   - 刷新Token到 refresh_token
   - Token过期时间到 expires_at
        ↓
5. 跳转到上传界面
```

### 自动登录流程（应用启动）

```
1. 应用启动
        ↓
2. 检查是否有保存的Token
        ↓
3. 如果有Token：
   ├─ 从本地缓存获取用户信息
   ├─ 验证Token是否有效（获取项目信息）
   │  ├─ 如果有效：使用缓存用户信息 ✅
   │  └─ 如果无效：
   │     ├─ 尝试用刷新Token获取新Token
   │     ├─ 更新缓存用户信息
   │     └─ 跳转到上传界面
   └─ 显示上传界面
        ↓
4. 如果没有Token：显示登录界面
```

### 登出流程

```
1. 用户点击"退出登录"
        ↓
2. 确认退出（弹出对话框）
        ↓
3. 清除以下信息：
   - 用户信息缓存 ✅
   - Token ✅
   - 刷新Token ✅
   - 全局状态
        ↓
4. 显示登录界面
```

## 数据流示例

### 首次登录

```
输入：
- username: "user123"
- password: "****"
- server: "http://42.192.76.234:8081"

↓ 登录成功

缓存保存：
{
  "server_url": "http://42.192.76.234:8081",
  "username": "user123",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_at": "2025-10-24T10:30:00Z",
  "user_info": {
    "id": 1,
    "username": "user123",
    "name": "张三",
    "email": "user@example.com",
    "role": "manager"
  }
}

↓ 跳转到上传界面
```

### 应用重启（自动登录）

```
应用启动
↓ 检查Token → 发现有效的Token和用户信息缓存
↓ 从缓存加载：
   - 用户ID: 1
   - 用户名: user123
   - 姓名: 张三
   - 邮箱: user@example.com
   - 角色: manager
↓ 验证Token有效性 → 成功
↓ 直接跳转到上传界面，无需登录
```

## 缓存管理

### 缓存何时更新

1. **用户登录成功时**
   - 自动保存新的用户信息
   
2. **Token刷新成功时**
   - 更新Token
   - 更新用户信息（如果返回）
   
3. **项目信息更新时**
   - 不影响用户信息缓存

### 缓存何时清除

1. **用户主动登出时**
   - 清除所有用户信息
   - 清除Token
   
2. **Token刷新失败时**
   - 清除缓存和Token
   - 回到登录界面
   
3. **手动清除配置时**
   - 调用 `clear_all()` 方法

## 安全考虑

### ✅ 已实现的安全措施

- ✅ Token 作为敏感信息存储在本地
- ✅ 登出时完全清除所有用户信息
- ✅ Token过期时自动刷新或重新登录
- ✅ 用户信息只在本地存储，不上传到服务器

### ⚠️ 注意事项

- 配置文件存储在用户主目录的 `.molten_salt_uploader` 目录
- 其他用户可能能够访问该目录（取决于操作系统权限设置）
- 建议在共享计算机上不要勾选"记住密码"

## 故障排查

### 问题 1：登录后应用重启仍然显示登录界面

**可能原因**：
- Token已过期且无法刷新
- 配置文件被删除或损坏

**解决方案**：
- 手动登录一次
- 检查 `~/.molten_salt_uploader/config.json` 文件是否存在

### 问题 2：缓存的用户信息不准确

**可能原因**：
- 用户信息在服务器端被修改
- 缓存未被更新

**解决方案**：
- 登出后重新登录
- 或者手动删除 `~/.molten_salt_uploader/config.json` 中的 `user_info` 字段

## 后续优化建议

1. **加密存储**：使用加密算法保护存储的Token
2. **加密用户信息**：对敏感的用户信息进行加密
3. **缓存过期**：实现缓存过期策略
4. **多用户支持**：支持多个用户的缓存（当前为单用户）
5. **缓存版本管理**：处理缓存格式升级
6. **磁盘空间管理**：实现缓存清理策略

## 修改文件列表

| 文件 | 修改内容 |
|------|---------|
| `services/config_service.py` | 添加 `save_user_info()`、`get_user_info()`、`clear_user_info()` 方法 |
| `ui/login_widget.py` | 登录成功后保存用户信息到本地缓存 |
| `ui/main_window.py` | 自动登录时从本地缓存加载用户信息，登出时清除缓存 |
