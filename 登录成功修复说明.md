# ç™»å½•æˆåŠŸä¿®å¤è¯´æ˜

## ğŸ¯ é—®é¢˜æè¿°

æ ¹æ®ç»ˆç«¯æ—¥å¿—æ˜¾ç¤ºï¼Œç™»å½•è¯·æ±‚æˆåŠŸï¼Œä½†å› ä¸º**ä¸šåŠ¡çŠ¶æ€ç ä¸åŒ¹é…**å¯¼è‡´ç™»å½•å¤±è´¥ï¼š

```
âœ… JSONè§£ææˆåŠŸ
å“åº”ç»“æ„: {'code': 1, 'msg': 'ç™»å½•æˆåŠŸ', ...}

âŒ ä¸šåŠ¡çŠ¶æ€ç é”™è¯¯: 1
é”™è¯¯ä¿¡æ¯: ç™»å½•å¤±è´¥
```

**é—®é¢˜åŸå› ï¼š**

- åç«¯è¿”å›çš„æˆåŠŸçŠ¶æ€ç æ˜¯ `1`
- å‰ç«¯æœŸæœ›çš„çŠ¶æ€ç æ˜¯ `200`
- å¯¼è‡´æˆåŠŸå“åº”è¢«åˆ¤æ–­ä¸ºå¤±è´¥

## ğŸ”§ ä¿®å¤å†…å®¹

### 1. ä¿®å¤ä¸šåŠ¡çŠ¶æ€ç åˆ¤æ–­

**æ–‡ä»¶ï¼š** `services/auth_service.py`

**ä¿®æ”¹å‰ï¼š**

```python
# æ£€æŸ¥å“åº”ç 
if result.get('code') != 200:
    error_msg = result.get('message', 'ç™»å½•å¤±è´¥')
    raise Exception(error_msg)
```

**ä¿®æ”¹åï¼š**

```python
# æ£€æŸ¥å“åº”ç ï¼ˆåç«¯æˆåŠŸç ä¸º1ï¼‰
if result.get('code') != 1:
    error_msg = result.get('msg', result.get('message', 'ç™»å½•å¤±è´¥'))
    raise Exception(error_msg)
```

**æ”¹è¿›ï¼š**

- âœ… çŠ¶æ€ç ï¼š`200` â†’ `1`
- âœ… é”™è¯¯æ¶ˆæ¯å­—æ®µï¼š`message` â†’ `msg`ï¼ˆä¼˜å…ˆä½¿ç”¨ `msg`ï¼Œå…¼å®¹ `message`ï¼‰

### 2. ä¿®å¤ç”¨æˆ·æ•°æ®æå–

**æ–‡ä»¶ï¼š** `services/auth_service.py`

**åç«¯è¿”å›çš„æ•°æ®ç»“æ„ï¼š**

```json
{
  "code": 1,
  "msg": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzUxMiJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiJ9...",
    "expiresIn": 86400,
    "expiresAt": 1761274267,
    "user": {
      "id": 10,
      "username": "13959141232",
      "name": "å¾ç»ç†",
      "email": null,
      "role": "MANAGER",
      "lastLoginTime": "2025-10-23T10:51:07Z"
    }
  }
}
```

**ä¿®æ”¹å‰ï¼š**

```python
data = result.get('data', {})
self.token = data.get('token')

return {
    'id': data.get('id', 1),
    'username': username,
    'token': self.token
}
```

**ä¿®æ”¹åï¼š**

```python
data = result.get('data', {})
user_data = data.get('user', {})
self.token = data.get('token')

return {
    'id': user_data.get('id'),
    'username': user_data.get('username'),
    'name': user_data.get('name'),
    'email': user_data.get('email'),
    'role': user_data.get('role'),
    'token': self.token,
    'refreshToken': data.get('refreshToken'),
    'expiresIn': data.get('expiresIn'),
    'expiresAt': data.get('expiresAt')
}
```

**æ”¹è¿›ï¼š**

- âœ… æ­£ç¡®æå–ç”¨æˆ·æ•°æ®ï¼š`data` â†’ `data.user`
- âœ… è¿”å›å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå§“åã€è§’è‰²ã€token ç­‰ï¼‰
- âœ… åŒ…å« refreshToken å’Œè¿‡æœŸæ—¶é—´

### 3. ä¼˜åŒ–ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º

**æ–‡ä»¶ï¼š** `ui/upload_widget.py`

**ä¿®æ”¹å‰ï¼š**

```python
def set_user_info(self, user_info: dict):
    self.user_info = user_info
    username = user_info.get('username', 'æœªçŸ¥ç”¨æˆ·')
    self.user_label.setText(f"ç”¨æˆ·ï¼š{username}")
```

**ä¿®æ”¹åï¼š**

```python
def set_user_info(self, user_info: dict):
    self.user_info = user_info

    # ä¼˜å…ˆæ˜¾ç¤ºå§“åï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºç”¨æˆ·å
    name = user_info.get('name')
    username = user_info.get('username', 'æœªçŸ¥ç”¨æˆ·')
    role = user_info.get('role', '')

    # æ„å»ºæ˜¾ç¤ºæ–‡æœ¬
    if name and name != username:
        display_text = f"ç”¨æˆ·ï¼š{name} ({username})"
    else:
        display_text = f"ç”¨æˆ·ï¼š{username}"

    # æ·»åŠ è§’è‰²ä¿¡æ¯
    role_map = {
        'MANAGER': 'ç®¡ç†å‘˜',
        'USER': 'æ™®é€šç”¨æˆ·',
        'ADMIN': 'ç³»ç»Ÿç®¡ç†å‘˜'
    }
    role_text = role_map.get(role, role)
    if role_text:
        display_text += f" | è§’è‰²ï¼š{role_text}"

    self.user_label.setText(display_text)
```

**æ˜¾ç¤ºæ•ˆæœï¼š**

- æœ‰å§“åï¼š`ç”¨æˆ·ï¼šå¾ç»ç† (13959141232) | è§’è‰²ï¼šç®¡ç†å‘˜`
- æ— å§“åï¼š`ç”¨æˆ·ï¼šadmin | è§’è‰²ï¼šç®¡ç†å‘˜`

### 4. æ·»åŠ è¯¦ç»†æ—¥å¿—

**æ–‡ä»¶ï¼š** `ui/main_window.py`, `ui/upload_widget.py`

åœ¨ç™»å½•æˆåŠŸå’Œç•Œé¢åˆ‡æ¢æ—¶æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š

```python
# ä¸»çª—å£
print("ã€ä¸»çª—å£ã€‘ç™»å½•æˆåŠŸï¼Œåˆ‡æ¢åˆ°ä¸Šä¼ ç•Œé¢")
print(f"ç”¨æˆ·ID: {user_info.get('id')}")
print(f"ç”¨æˆ·å: {user_info.get('username')}")
print(f"å§“å: {user_info.get('name')}")

# ä¸Šä¼ ç•Œé¢
print("ã€UIå±‚ã€‘è¿›å…¥ä¸Šä¼ é¡µé¢")
print(f"ç”¨æˆ·ä¿¡æ¯: {user_info}")
print(f"âœ… ç”¨æˆ·ä¿¡æ¯å·²è®¾ç½®: {display_text}")
```

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| é¡¹ç›®             | ä¿®å¤å‰ âŒ           | ä¿®å¤å âœ…            |
| ---------------- | ------------------- | -------------------- |
| **ä¸šåŠ¡çŠ¶æ€ç **   | æœŸæœ› 200            | æœŸæœ› 1               |
| **é”™è¯¯æ¶ˆæ¯å­—æ®µ** | message             | msg (å…¼å®¹ message)   |
| **ç”¨æˆ·æ•°æ®æå–** | data.id             | data.user.id         |
| **è¿”å›å­—æ®µ**     | id, username, token | å®Œæ•´ç”¨æˆ·ä¿¡æ¯         |
| **ç”¨æˆ·æ˜¾ç¤º**     | ç”¨æˆ·å              | å§“å + ç”¨æˆ·å + è§’è‰² |
| **æ—¥å¿—è¾“å‡º**     | åŸºæœ¬ä¿¡æ¯            | è¯¦ç»†çš„ç™»å½•æµç¨‹æ—¥å¿—   |

## ğŸš€ æµ‹è¯•ç»“æœ

### æœŸæœ›çš„å®Œæ•´ç™»å½•æµç¨‹æ—¥å¿—ï¼š

```
============================================================
ã€UIå±‚ã€‘ç™»å½•æŒ‰é’®ç‚¹å‡»
æœåŠ¡å™¨: http://42.192.76.234:8081
ç”¨æˆ·å: 13959141232
å¯†ç é•¿åº¦: 6
============================================================

ğŸš€ å¼€å§‹ç™»å½•æµç¨‹...

============================================================
ã€ç™»å½•çº¿ç¨‹ã€‘å¼€å§‹æ‰§è¡Œ
============================================================

============================================================
ã€ç™»å½•è¯·æ±‚ã€‘
URL: http://42.192.76.234:8081/api/v1/auth/login
ç™»å½•ç±»å‹: æ‰‹æœºå·
ç™»å½•è´¦å·: 13959141232
å¯†ç : ******
è¯·æ±‚æ•°æ®: {'phone': '13959141232', 'password': '******'}
============================================================

============================================================
ã€ç™»å½•å“åº”ã€‘
çŠ¶æ€ç : 200
å“åº”å¤´: {...}
å“åº”å†…å®¹: {"code":1,"msg":"ç™»å½•æˆåŠŸ",...}
============================================================

âœ… JSONè§£ææˆåŠŸ
å“åº”ç»“æ„: {'code': 1, 'msg': 'ç™»å½•æˆåŠŸ', ...}

âœ… ç™»å½•æˆåŠŸ
ç”¨æˆ·ID: 10
ç”¨æˆ·å: 13959141232
å§“å: å¾ç»ç†
è§’è‰²: MANAGER
Token: eyJhbGciOiJIUzUxMiJ9.eyJyb2...

âœ… ç™»å½•çº¿ç¨‹æˆåŠŸï¼Œå‘é€æˆåŠŸä¿¡å·

============================================================
ã€UIå±‚ã€‘ç™»å½•æˆåŠŸ
ç”¨æˆ·ä¿¡æ¯: {'id': 10, 'username': '13959141232', ...}
============================================================

============================================================
ã€ä¸»çª—å£ã€‘ç™»å½•æˆåŠŸï¼Œåˆ‡æ¢åˆ°ä¸Šä¼ ç•Œé¢
ç”¨æˆ·ID: 10
ç”¨æˆ·å: 13959141232
å§“å: å¾ç»ç†
============================================================

============================================================
ã€UIå±‚ã€‘è¿›å…¥ä¸Šä¼ é¡µé¢
ç”¨æˆ·ä¿¡æ¯: {...}
============================================================

âœ… ç”¨æˆ·ä¿¡æ¯å·²è®¾ç½®: ç”¨æˆ·ï¼šå¾ç»ç† (13959141232) | è§’è‰²ï¼šç®¡ç†å‘˜

âœ… ç•Œé¢åˆ‡æ¢å®Œæˆ

ğŸ”„ ç™»å½•æµç¨‹ç»“æŸï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
```

## ğŸ“ æ¶‰åŠæ–‡ä»¶

| æ–‡ä»¶                       | ä¿®æ”¹å†…å®¹                                   |
| -------------------------- | ------------------------------------------ |
| `services/auth_service.py` | ä¿®å¤çŠ¶æ€ç åˆ¤æ–­ã€æ•°æ®æå–ã€è¿”å›å®Œæ•´ç”¨æˆ·ä¿¡æ¯ |
| `ui/upload_widget.py`      | ä¼˜åŒ–ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºã€æ·»åŠ æ—¥å¿—                 |
| `ui/main_window.py`        | æ·»åŠ ç™»å½•æˆåŠŸæ—¥å¿—                           |

## ğŸ¯ ç°åœ¨æµ‹è¯•

```bash
# è¿è¡Œç¨‹åº
python3 main.py

# è¾“å…¥ç™»å½•ä¿¡æ¯
# æœåŠ¡å™¨ï¼šhttp://42.192.76.234:8081
# ç”¨æˆ·å/æ‰‹æœºå·ï¼š13959141232
# å¯†ç ï¼š123456

# ç‚¹å‡»ç™»å½•æŒ‰é’®
# é¢„æœŸç»“æœï¼š
# 1. ç™»å½•æˆåŠŸ
# 2. è‡ªåŠ¨è·³è½¬åˆ°ä¸Šä¼ ç•Œé¢
# 3. æ˜¾ç¤ºï¼šç”¨æˆ·ï¼šå¾ç»ç† (13959141232) | è§’è‰²ï¼šç®¡ç†å‘˜
```

## ğŸŒŸ åç»­ä¼˜åŒ–å»ºè®®

### 1. Token ç®¡ç†

- ä¿å­˜ Token åˆ°æœ¬åœ°ï¼ˆè®°ä½ç™»å½•çŠ¶æ€ï¼‰
- Token è‡ªåŠ¨åˆ·æ–°ï¼ˆä½¿ç”¨ refreshTokenï¼‰
- Token è¿‡æœŸå¤„ç†

### 2. é¡¹ç›®åˆ—è¡¨

- ä» API åŠ¨æ€åŠ è½½é¡¹ç›®åˆ—è¡¨
- æ ¹æ®ç”¨æˆ·æƒé™æ˜¾ç¤ºå¯è®¿é—®çš„é¡¹ç›®

### 3. ç”¨æˆ·å¤´åƒ

- å¦‚æœåç«¯æä¾›å¤´åƒ URLï¼Œå¯ä»¥æ˜¾ç¤ºç”¨æˆ·å¤´åƒ

### 4. æƒé™æ§åˆ¶

- æ ¹æ®è§’è‰²æ§åˆ¶åŠŸèƒ½æƒé™
- MANAGER å¯èƒ½æœ‰æ›´å¤šæƒé™

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-10-23  
**ç‰ˆæœ¬**ï¼šv1.2  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ
