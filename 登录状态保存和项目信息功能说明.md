# 登录状态保存和项目信息功能说明

## 📋 功能概述

本次更新实现了以下核心功能：

1. **登录状态保存** - 支持记住账号密码，自动登录
2. **Token 管理** - 实现 Token 刷新机制
3. **项目信息展示** - 调用 my-project 接口并在界面展示项目详情

## 🎯 实现的功能

### 1. 配置管理服务 (config_service.py)

新增了配置管理服务，用于持久化存储用户配置：

- **配置存储位置**: `~/.molten_salt_uploader/config.json`
- **存储内容**:
  - 服务器地址
  - 用户名
  - 密码（可选，简单加密）
  - Token 和 RefreshToken
  - Token 过期时间

**主要方法**:

```python
# 保存登录信息
save_login_info(server_url, username, password, remember_password)

# 获取登录信息
get_login_info()

# 保存Token
save_token(token, refresh_token, expires_at)

# 获取Token
get_token()

# 清除Token
clear_token()
```

### 2. 项目服务 (project_service.py)

新增了项目服务，用于获取项目信息：

- **接口地址**: `/api/v1/projects/my-project`
- **请求方法**: GET
- **请求头**: 需要在 header 中添加`token`字段
- **返回数据结构**:

```json
{
  "code": 1,
  "msg": "获取项目成功",
  "data": {
    "id": 9,
    "name": "小目标测试项目",
    "type": "binary",
    "typeDisplayName": "二元化盐项目",
    "manager": "徐经理",
    "managerId": 10,
    "contactPhone": "13959141232",
    "estimatedSaltAmount": 50.00,
    "actualSaltAmount": 550.00,
    "status": "in_progress",
    "statusDisplayName": "进行中",
    "completionProgress": 999.99,
    ...
  }
}
```

### 3. Token 刷新功能

在认证服务中新增了 Token 刷新机制：

- **刷新接口**: `/api/v1/auth/refresh`
- **自动刷新**: 当 Token 过期时，自动使用 RefreshToken 获取新 Token
- **无感刷新**: 用户无需重新登录

**主要方法**:

```python
# 刷新Token
refresh_access_token()

# 设置Token（用于恢复登录状态）
set_token(token, api_base_url, refresh_token)
```

### 4. 登录界面更新

新增了记住密码功能：

- ✅ 添加"记住密码"复选框
- ✅ 勾选后保存账号和密码
- ✅ 下次打开自动填充
- ✅ 登录成功后保存 Token

**UI 改进**:

```
┌─────────────────────────────┐
│  熔盐管理系统                │
│  文件上传工具                │
│                              │
│  服务器地址:                 │
│  [http://...]               │
│                              │
│  用户名/手机号:              │
│  [输入框]                    │
│                              │
│  密码:                       │
│  [输入框]                    │
│                              │
│  ☑ 记住密码                  │
│                              │
│  [登  录]                    │
└─────────────────────────────┘
```

### 5. 主窗口更新

实现了自动登录功能：

- ✅ 启动时检查是否有保存的 Token
- ✅ Token 有效则直接跳转到上传界面
- ✅ Token 过期则尝试刷新
- ✅ 刷新失败则显示登录界面

**自动登录流程**:

```
启动应用
  ↓
检查保存的Token
  ↓
有Token? ── 否 → 显示登录界面
  ↓ 是
尝试获取项目信息（验证Token）
  ↓
Token有效? ── 是 → 跳转到上传界面
  ↓ 否
尝试刷新Token
  ↓
刷新成功? ── 是 → 跳转到上传界面
  ↓ 否
清除Token，显示登录界面
```

### 6. 上传界面更新

新增了项目信息展示：

**界面布局**:

```
┌───────────────────────────────────────────────┐
│ 📁 日报文件上传              [退出登录]       │
├───────────────────────────────────────────────┤
│ 用户和项目信息                                │
│                                               │
│ 用户: 张三 (zhangsan) | 角色: 管理员          │
│                                               │
│ 当前项目: 小目标测试项目                      │
│                                               │
│ 项目类型: 二元化盐项目  状态: 进行中          │
│ 项目经理: 徐经理  完成进度: 999.99%           │
├───────────────────────────────────────────────┤
│ 添加文件                                      │
│ ...                                           │
└───────────────────────────────────────────────┘
```

**显示信息**:

- 项目名称（蓝色加粗显示）
- 项目类型（typeDisplayName）
- 项目状态（statusDisplayName，进行中为绿色）
- 项目经理
- 完成进度（百分比）

## 🔧 使用流程

### 首次使用

1. 输入服务器地址、用户名和密码
2. 勾选"记住密码"（可选）
3. 点击"登录"
4. 登录成功后自动跳转到上传界面
5. 上传界面显示用户信息和项目信息

### 再次使用

#### 场景 1：未勾选记住密码

- 启动应用 → 显示登录界面
- 自动填充服务器地址和用户名
- 需要手动输入密码

#### 场景 2：勾选了记住密码

- 启动应用 → 显示登录界面
- 自动填充服务器地址、用户名和密码
- 可以直接点击登录

#### 场景 3：Token 仍然有效

- 启动应用 → 自动验证 Token
- Token 有效 → 直接跳转到上传界面
- **无需重新登录！**

#### 场景 4：Token 已过期

- 启动应用 → 自动验证 Token
- Token 过期 → 自动刷新 Token
- 刷新成功 → 直接跳转到上传界面
- 刷新失败 → 显示登录界面

## 🔒 安全说明

### 密码存储

- 使用简单的 Base64 编码存储
- 仅供测试使用
- **生产环境建议使用更安全的加密方式**（如 AES 加密）

### Token 管理

- Token 和 RefreshToken 存储在本地配置文件
- 退出登录时会清除 Token
- Token 过期后自动刷新

### 配置文件位置

- **macOS**: `~/.molten_salt_uploader/config.json`
- **Windows**: `C:\Users\用户名\.molten_salt_uploader\config.json`
- **Linux**: `~/.molten_salt_uploader/config.json`

## 📝 API 集成说明

### 登录接口

- **地址**: `/api/v1/auth/login`
- **方法**: POST
- **返回**: 包含 token 和 refreshToken

### Token 刷新接口

- **地址**: `/api/v1/auth/refresh`
- **方法**: POST
- **参数**: `{"refreshToken": "..."}`
- **返回**: 新的 token 和 refreshToken

### 项目信息接口

- **地址**: `/api/v1/projects/my-project`
- **方法**: GET
- **请求头**: `{"token": "..."}`
- **返回**: 当前用户的默认项目信息

## 🎨 UI 优化

### 登录界面

- ✅ 添加记住密码复选框
- ✅ 保持原有配色和布局
- ✅ 支持回车键登录

### 上传界面

- ✅ 重新设计用户和项目信息面板
- ✅ 采用两行布局，信息更清晰
- ✅ 项目状态使用颜色区分
- ✅ 项目名称突出显示

## 🐛 错误处理

### Token 验证失败

- 自动尝试刷新 Token
- 刷新失败则提示重新登录

### 项目信息获取失败

- 显示"未加载"状态
- 打印错误日志便于调试
- 不影响其他功能使用

### 网络异常

- 显示友好的错误提示
- 自动恢复到登录界面

## 📊 代码结构

```
services/
  ├── config_service.py      # 配置管理服务（新增）
  ├── project_service.py     # 项目服务（新增）
  ├── auth_service.py        # 认证服务（更新）
  └── upload_service.py      # 上传服务

ui/
  ├── login_widget.py        # 登录界面（更新）
  ├── main_window.py         # 主窗口（更新）
  └── upload_widget.py       # 上传界面（更新）
```

## ✅ 测试建议

1. **首次登录测试**

   - 勾选记住密码
   - 验证登录成功
   - 验证项目信息显示

2. **自动登录测试**

   - 关闭应用
   - 重新打开
   - 验证是否自动登录

3. **Token 刷新测试**

   - 等待 Token 过期
   - 重新打开应用
   - 验证 Token 自动刷新

4. **退出登录测试**
   - 点击退出登录
   - 验证 Token 被清除
   - 重新打开应用，应显示登录界面

## 🚀 后续优化建议

1. **密码加密**

   - 使用 AES 或其他安全加密算法
   - 添加密钥管理

2. **用户信息接口**

   - 添加专门的用户信息接口
   - 避免依赖登录返回的用户数据

3. **多项目支持**

   - 支持切换不同项目
   - 添加项目列表下拉框

4. **Token 自动刷新**

   - 在 Token 即将过期时主动刷新
   - 避免等到过期后才刷新

5. **离线模式**
   - 缓存项目信息
   - 支持离线查看

## 📞 技术支持

如有问题，请查看日志输出或联系开发团队。

---

**更新日期**: 2025-10-23
**版本**: v2.0
