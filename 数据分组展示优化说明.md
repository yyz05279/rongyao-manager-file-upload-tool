# 数据分组展示优化说明

## 修改日期

2025 年 10 月 23 日

## 问题描述

数据展示没有按照 Excel 的序号结构进行分组展示，导致用户难以理解数据的层级关系。

## 修改内容

### 1. Excel 数据结构说明

根据 Excel 原始格式，数据结构如下：

#### 一、项目整体信息

- 项目名称
- 整体进度状态
- 进度描述

#### 二、逐项进度汇报（序号 2.x）

- 序号 2.1, 2.2, 2.3...
- 字段：任务名称、计划进度、实际进度、偏差原因、影响及措施

#### 三、明日工作计划（序号 3.x）

- 序号 3.1, 3.2, 3.3...
- 字段：任务名称、目标、负责人、所需资源、备注

#### 二、各工种工作汇报（中文序号）

- 字段：姓名、工种、类型、工作内容、工时

#### 三、机械租赁情况（中文序号）

- 字段：机械名称、数量、吨位、用途、合班、备注

#### 四、问题反馈（中文序号）

分为两个子区域：

##### 1. 问题反馈（序号 1.x）

- 序号 1.1, 1.2, 1.3...
- 字段：问题描述、原因、影响、处理进度

##### 2. 需求描述（序号 2.x）

- 序号 2.1, 2.2, 2.3...
- 字段：需求描述、紧急程度、期望时间

### 2. UI 调整内容

#### 2.1 选项卡标题优化

调整了选项卡标题，清晰标识 Excel 中的序号结构：

```python
# 原标题 → 新标题
"📋 任务进度" → "📋 逐项进度汇报（序号2）"
"📅 明日计划" → "📅 明日工作计划（序号3）"
"👷 人员报告" → "👷 各工种工作汇报（二）"
"🚜 机械租赁" → "🚜 机械租赁情况（三）"
"⚠️ 问题反馈" + "📝 需求描述" → "⚠️ 问题反馈（四）"（合并）
```

#### 2.2 问题反馈选项卡重构

将原来独立的"问题反馈"和"需求描述"两个选项卡合并为一个"问题反馈（四）"选项卡，内部分为两个分组：

- **1. 问题反馈** - 使用红色标题，突出显示

  - 表格列：序号、问题描述、原因、影响、处理进度
  - 问题描述文字标红显示，引起重视

- **2. 需求描述** - 使用蓝色标题
  - 表格列：序号、需求描述、紧急程度、期望时间

#### 2.3 机械租赁字段完善

补充了机械租赁表格的字段：

```python
# 原字段：序号、机械名称、数量、用途、备注
# 新字段：序号、机械名称、数量、吨位、用途、合班、备注
```

### 3. 代码变更

#### 3.1 新增方法

- `create_problems_and_requirements_tab()` - 创建合并的问题反馈选项卡
- `_create_problems_group()` - 创建问题反馈分组
- `_create_requirements_group()` - 创建需求描述分组

#### 3.2 修改方法

- `create_machinery_tab()` - 增加了"吨位"和"合班"字段

### 4. 数据字段映射

#### 问题反馈

```python
{
  "problemNo": "序号",        # 如：1.1, 1.2
  "description": "问题描述",
  "reason": "原因",
  "impact": "影响",
  "progress": "处理进度"
}
```

#### 需求描述

```python
{
  "requirementNo": "序号",    # 如：2.1, 2.2
  "description": "需求描述",
  "urgencyLevel": "紧急程度",
  "expectedTime": "期望时间"
}
```

#### 机械租赁

```python
{
  "seqNo": "序号",
  "machineName": "机械名称",
  "quantity": "数量",
  "tonnage": "吨位",           # 新增
  "usage": "用途",
  "shift": "合班",             # 新增
  "remarks": "备注"
}
```

## 优化效果

### 1. 清晰的层级结构

选项卡标题明确标识了 Excel 中的序号，用户可以快速定位到对应的数据区域。

### 2. 逻辑分组展示

将相关联的"问题反馈"和"需求描述"合并展示，符合 Excel 原始的"四、问题反馈"大区域结构。

### 3. 完整的字段显示

机械租赁表格补充了"吨位"和"合班"字段，与 Excel 结构完全对应。

### 4. 视觉突出重点

问题反馈使用红色标题和红色文字，突出显示重要信息。

## 文件变更列表

### 修改文件

- `ui/daily_report_detail_dialog.py` - 日报详情对话框 UI

### 相关文件（未修改）

- `parse_daily_report_excel.py` - Excel 解析器（字段名已正确）
- `services/upload_service.py` - 上传服务

## 注意事项

1. **序号体系区分**

   - 阿拉伯数字序号（2.x, 3.x）：用于逐项进度汇报和明日工作计划
   - 中文序号（二、三、四）：用于各工种汇报、机械租赁、问题反馈大区域
   - 问题反馈内部的子序号（1.x, 2.x）：分别对应问题反馈和需求描述

2. **数据解析要求**

   - `parse_daily_report_excel.py` 需要正确解析 Excel 中的序号
   - 序号字段名：`taskNo`, `planNo`, `problemNo`, `requirementNo` 等

3. **UI 滚动支持**
   - 问题反馈选项卡使用了 `QScrollArea`，支持内容较多时滚动查看

## 测试建议

1. 使用包含完整数据的 Excel 文件测试
2. 验证序号是否正确显示（2.1, 3.1, 1.1, 2.1 等）
3. 检查问题反馈和需求描述是否正确分组
4. 确认机械租赁的所有字段是否正确显示

## 后续优化建议

1. 考虑在基本信息面板中也标识序号结构
2. 可以在表格中增加序号排序功能
3. 对于空数据的区域，可以显示更友好的提示信息
