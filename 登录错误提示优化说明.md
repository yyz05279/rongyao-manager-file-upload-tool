# 登录错误提示优化说明

## 🎯 优化目标

确保登录失败时，错误提示窗直接展示后端接口返回的 `msg` 数据，避免重复或冗余的提示文本。

## 🔧 优化内容

### 1. 优化错误消息提取

**文件：** `services/auth_service.py`

**修改前：**

```python
def _extract_error_message(self, response) -> str:
    try:
        result = response.json()
        return result.get('message', f'HTTP {response.status_code}')
    except:
        return f'HTTP {response.status_code}'
```

**修改后：**

```python
def _extract_error_message(self, response) -> str:
    try:
        result = response.json()
        # 优先使用 msg 字段，兼容 message 字段
        error_msg = result.get('msg', result.get('message', ''))
        if error_msg:
            return error_msg
        # 如果没有错误消息，返回状态码
        return f'HTTP {response.status_code}'
    except:
        return f'HTTP {response.status_code}'
```

**改进：**

- ✅ 优先提取 `msg` 字段（后端使用的字段）
- ✅ 兼容 `message` 字段（部分接口可能使用）
- ✅ 没有错误消息时返回 HTTP 状态码

### 2. 智能显示错误消息

**文件：** `ui/login_widget.py`

**优化逻辑：**

```python
# 直接显示后端返回的msg，不添加额外前缀
# 如果错误消息本身已包含关键词，就直接显示
# 否则添加"登录失败："前缀
keywords = [
    '登录', '失败', '错误', '密码', '用户', '账号',
    '锁定', '过期', '禁用', '验证', '连接', '超时',
    '网络', '服务器', '未找到', '不存在'
]
if any(keyword in error_message for keyword in keywords):
    msg_box.setText(error_message)
else:
    msg_box.setText(f"登录失败：{error_message}")
```

**改进：**

- ✅ 智能判断是否需要添加"登录失败："前缀
- ✅ 包含关键词的消息直接显示，避免重复
- ✅ 不包含关键词的消息添加前缀，提供上下文

### 3. 优化对话框样式

**改进：**

```python
msg_box.setStyleSheet("""
    QMessageBox {
        background-color: white;
    }
    QMessageBox QLabel {
        color: #000000;
        font-size: 14px;
        min-width: 350px;  # 增加最小宽度
        padding: 10px;     # 增加内边距
    }
    QPushButton {
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 6px 16px;
        font-size: 13px;
        min-width: 70px;
    }
    QPushButton:hover {
        background-color: #da190b;
    }
""")
```

**改进：**

- ✅ 增加对话框最小宽度（350px）
- ✅ 增加文本内边距（10px）
- ✅ 确保黑色字体显示
- ✅ 美化按钮样式

## 📊 错误消息显示示例

### 后端返回的错误消息

| 后端 msg               | 是否包含关键词 | 显示消息               |
| ---------------------- | -------------- | ---------------------- |
| `用户名或密码错误`     | ✅             | `用户名或密码错误`     |
| `账号已被锁定`         | ✅             | `账号已被锁定`         |
| `账号已被禁用`         | ✅             | `账号已被禁用`         |
| `密码已过期`           | ✅             | `密码已过期`           |
| `验证码错误`           | ✅             | `验证码错误`           |
| `登录失败，请稍后重试` | ✅             | `登录失败，请稍后重试` |
| `连接超时，请检查网络` | ✅             | `连接超时，请检查网络` |
| `服务器错误`           | ✅             | `服务器错误`           |
| `用户不存在`           | ✅             | `用户不存在`           |
| `HTTP 401`             | ❌             | `登录失败：HTTP 401`   |
| `HTTP 500`             | ❌             | `登录失败：HTTP 500`   |

### 网络错误消息

| 错误类型      | 显示消息                                   |
| ------------- | ------------------------------------------ |
| 连接超时      | `连接超时，请检查服务器地址`               |
| 连接失败      | `无法连接到服务器，请检查服务器地址和网络` |
| 网络请求失败  | `网络请求失败：{详细信息}`                 |
| JSON 解析错误 | `服务器响应格式错误：{详细信息}`           |

## 🎨 显示效果对比

### 优化前 ❌

**场景 1：** 后端返回 `用户名或密码错误`

- **显示：** `登录失败：用户名或密码错误`
- **问题：** 重复提示"登录失败"

**场景 2：** 后端返回 `账号已被锁定`

- **显示：** `登录失败：账号已被锁定`
- **问题：** 添加了不必要的前缀

**场景 3：** 后端返回 `HTTP 401`

- **显示：** `登录失败：HTTP 401`
- **问题：** 状态码不够友好

### 优化后 ✅

**场景 1：** 后端返回 `用户名或密码错误`

- **显示：** `用户名或密码错误`
- **优点：** 简洁明了，直接显示后端消息

**场景 2：** 后端返回 `账号已被锁定`

- **显示：** `账号已被锁定`
- **优点：** 直接显示，无冗余前缀

**场景 3：** 后端返回 `HTTP 401`

- **显示：** `登录失败：HTTP 401`
- **优点：** 添加前缀提供上下文

## 🔍 日志输出

登录失败时的日志：

```
============================================================
【UI层】登录失败
后端返回错误: 用户名或密码错误
============================================================
```

## 📝 关键词列表

当前支持的关键词（会直接显示，不添加前缀）：

```python
[
    '登录', '失败', '错误', '密码', '用户', '账号',
    '锁定', '过期', '禁用', '验证', '连接', '超时',
    '网络', '服务器', '未找到', '不存在'
]
```

**设计原则：**

- 包含这些关键词的消息通常已经是完整的错误描述
- 不需要再添加"登录失败："前缀
- 保持错误提示的简洁性和可读性

## 🎯 测试场景

### 1. 测试错误密码

**输入：**

- 用户名：`13959141232`
- 密码：`wrong_password`

**期望后端返回：**

```json
{
  "code": 0,
  "msg": "用户名或密码错误"
}
```

**期望显示：**

- 对话框标题：`登录失败`
- 对话框内容：`用户名或密码错误`

### 2. 测试锁定账号

**期望后端返回：**

```json
{
  "code": 0,
  "msg": "账号已被锁定，请联系管理员"
}
```

**期望显示：**

- 对话框标题：`登录失败`
- 对话框内容：`账号已被锁定，请联系管理员`

### 3. 测试网络错误

**场景：** 服务器未启动

**显示：**

- 对话框标题：`登录失败`
- 对话框内容：`无法连接到服务器，请检查服务器地址和网络`

### 4. 测试 HTTP 错误

**场景：** 接口不存在（404）

**期望显示：**

- 对话框标题：`登录失败`
- 对话框内容：`登录失败：HTTP 404`（如果后端没有返回 msg）

## 📊 优化效果

| 指标             | 优化前        | 优化后      |
| ---------------- | ------------- | ----------- |
| **显示后端 msg** | ❌ 可能被覆盖 | ✅ 优先显示 |
| **避免重复**     | ❌ 可能重复   | ✅ 智能判断 |
| **消息清晰度**   | ⭐⭐⭐        | ⭐⭐⭐⭐⭐  |
| **用户体验**     | ⭐⭐⭐        | ⭐⭐⭐⭐⭐  |

## 🚀 使用建议

### 后端开发建议

为了更好的用户体验，后端返回的错误消息应该：

1. **清晰明确**

   ```json
   ✅ {"code": 0, "msg": "用户名或密码错误"}
   ❌ {"code": 0, "msg": "error"}
   ```

2. **用户友好**

   ```json
   ✅ {"code": 0, "msg": "密码已过期，请修改密码"}
   ❌ {"code": 0, "msg": "ERR_PWD_EXPIRED"}
   ```

3. **提供建议**
   ```json
   ✅ {"code": 0, "msg": "账号已被锁定，请联系管理员"}
   ❌ {"code": 0, "msg": "账号锁定"}
   ```

## 📝 涉及文件

| 文件                       | 修改内容                                                |
| -------------------------- | ------------------------------------------------------- |
| `services/auth_service.py` | 优化 `_extract_error_message` 方法，优先提取 `msg` 字段 |
| `ui/login_widget.py`       | 智能显示错误消息，避免重复前缀                          |

---

**更新日期**：2025-10-23  
**版本**：v1.3  
**状态**：✅ 已完成
